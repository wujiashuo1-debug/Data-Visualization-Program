{% extends "base.html" %}

{% block title %}ä¸»é¡µ - æ•°æ®å¯è§†åŒ–ç¨‹åº{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <header class="dashboard-header">
        <div class="header-content">
            <h1 class="header-title">{{ texts.app_title }}</h1>
            <div class="header-right">
                <a href="{{ url_for('dashboard_new') }}" class="btn btn-dashboard-mode" title="{{ texts.switch_to_dashboard }}">
                    ğŸ“Š {{ texts.dashboard_mode }}
                </a>
                <!-- è¯­è¨€åˆ‡æ¢æŒ‰é’® -->
                <div class="language-switcher">
                    <button onclick="switchLanguage('zh')" class="btn btn-lang {% if lang == 'zh' %}active{% endif %}" id="lang-btn-zh" title="ä¸­æ–‡">
                        ğŸ‡¨ğŸ‡³ ä¸­æ–‡
                    </button>
                    <button onclick="switchLanguage('en')" class="btn btn-lang {% if lang == 'en' %}active{% endif %}" id="lang-btn-en" title="English">
                        ğŸ‡ºğŸ‡¸ EN
                    </button>
                </div>
                <span class="welcome-text">{{ texts.welcome }}ï¼Œ{{ username }}</span>
                <a href="{{ url_for('logout') }}" class="btn btn-logout">{{ texts.logout }}</a>
            </div>
        </div>
    </header>

    <div class="dashboard-body">
        <!-- å·¦ä¾§è¾¹æ  -->
        <aside class="sidebar">
            <!-- æ•°æ®åŒºåŸŸ -->
            <div class="sidebar-section">
                <div class="section-header">
                    <h3 class="section-title">
                        <span class="icon">ğŸ“Š</span>
                        {{ texts.data }}
                    </h3>
                </div>

                <!-- æ–‡ä»¶ä¸Šä¼ æŒ‰é’® -->
                <div class="upload-area">
                    <button class="btn btn-upload" onclick="document.getElementById('fileInput').click()">
                        <span>ğŸ“</span> {{ texts.upload_file }}
                    </button>
                    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" style="display: none;" onchange="uploadFile(this)">
                    <p class="upload-hint">{{ texts.support_formats }}</p>
                </div>

                <!-- æ–‡ä»¶é€‰æ‹©ä¸‹æ‹‰æ¡† -->
                <div class="file-selector">
                    <h4 class="file-selector-title">{{ texts.select_data_source }}</h4>
                    <div class="file-selector-wrapper">
                        {% if data_files %}
                            <select id="fileSelector" class="file-select" onchange="handleFileSelect(this.value)">
                                <option value="">{{ texts.please_select_file }}</option>
                                {% for file in data_files %}
                                <option value="{{ file.id }}" {% if loop.first %}selected{% endif %}>
                                    {{ file.original_filename }}
                                </option>
                                {% endfor %}
                            </select>
                            <div class="file-actions">
                                <button class="btn-preview" onclick="previewSelectedFile()" title="é¢„è§ˆæ•°æ®">
                                    ğŸ‘ï¸ é¢„è§ˆ
                                </button>
                                <button class="btn-delete-file" onclick="deleteSelectedFile()" title="åˆ é™¤æ–‡ä»¶">
                                    ğŸ—‘ï¸ åˆ é™¤
                                </button>
                            </div>
                        {% else %}
                            <p class="no-data">æš‚æ— æ•°æ®æ–‡ä»¶</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- ç»´åº¦å’Œåº¦é‡åŒºåŸŸ -->
            <div class="sidebar-section" id="columnsSection" style="display: none;">
                <div class="section-header">
                    <h3 class="section-title">
                        <span class="icon">ğŸ“</span>
                        å­—æ®µ
                    </h3>
                </div>

                <!-- å½“å‰é€‰ä¸­çš„æ–‡ä»¶å -->
                <div class="selected-file-info">
                    <p class="selected-file-name" id="selectedFileName"></p>
                </div>

                <!-- ç»´åº¦åˆ—è¡¨ -->
                <div class="column-group">
                    <h4 class="column-group-title">
                        <span class="collapse-icon" onclick="toggleGroup('dimensions')">â–¼</span>
                        ç»´åº¦
                    </h4>
                    <div class="column-list" id="dimensionsList">
                        <!-- é€šè¿‡ JavaScript åŠ¨æ€å¡«å…… -->
                    </div>
                </div>

                <!-- åº¦é‡åˆ—è¡¨ -->
                <div class="column-group">
                    <h4 class="column-group-title">
                        <span class="collapse-icon" onclick="toggleGroup('measures')">â–¼</span>
                        åº¦é‡
                    </h4>
                    <div class="column-list" id="measuresList">
                        <!-- é€šè¿‡ JavaScript åŠ¨æ€å¡«å…… -->
                    </div>
                </div>
            </div>
        </aside>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <main class="dashboard-main">
            <!-- å›¾è¡¨åˆ›å»ºåŒº -->
            <div class="chart-create-zone" id="chartCreateZone" 
                 ondrop="dropFileToCreate(event)" 
                 ondragover="allowDropFile(event)"
                 ondragleave="leaveDropFile(event)">
                <div class="create-zone-content">
                    <div class="create-zone-icon">ğŸ¨</div>
                    <h3 id="chartCreateTitle">{{ texts.chart_creation_zone }}</h3>
                    <p id="chartCreateHint">{{ texts.drag_file_to_create }}</p>
                </div>
            </div>

            <!-- å¯è§†åŒ–ç±»å‹é€‰æ‹©å’Œä¸»é¢˜é€‰æ‹© -->
            <div class="visualization-type-selector" id="tableTypeSelector" style="display: none;">
                <div class="selector-group">
                    <label class="vis-type-label" id="visTypeLabel">{{ texts.visualization_type }}ï¼š</label>
                    <select id="visualizationTypeSelect" class="vis-type-select" onchange="handleVisualizationTypeChange(this.value)">
                        <option value="list">ğŸ“‹ {{ texts.list_table }}</option>
                        <option value="cross">ğŸ“Š {{ texts.cross_table }}</option>
                        <option value="line">ğŸ“ˆ {{ texts.line_chart }}</option>
                        <option value="area">ğŸ“Š {{ texts.area_chart }}</option>
                        <option value="pie">ğŸ¥§ {{ texts.pie_chart }}</option>
                        <option value="bar">ğŸ“Š {{ texts.bar_chart }}</option>
                        <option value="waterfall">ğŸ“ˆ {{ texts.waterfall_chart }}</option>
                        <option value="scatter">ğŸ”µ {{ texts.scatter_chart }}</option>
                        <option value="combo_single">ğŸ“Š {{ texts.combo_single }}</option>
                        <option value="combo_dual">ğŸ“Š {{ texts.combo_dual }}</option>
                        <option value="wordcloud">â˜ï¸ {{ texts.wordcloud }}</option>
                        <option value="sunburst">â˜€ï¸ {{ texts.sunburst }}</option>
                        <option value="map">ğŸ—ºï¸ {{ texts.map }}</option>
                    </select>
                </div>
                
                <div class="selector-group">
                    <label class="vis-type-label" id="themeLabel">{{ texts.theme }}ï¼š</label>
                    <select id="themeSelect" class="theme-select" onchange="handleThemeChange(this.value)">
                        <option value="purple">ğŸŸ£ {{ texts.purple }}</option>
                        <option value="blue">ğŸ”µ {{ texts.blue }}</option>
                        <option value="green">ğŸŸ¢ {{ texts.green }}</option>
                        <option value="red">ğŸ”´ {{ texts.red }}</option>
                        <option value="orange">ğŸŸ  {{ texts.orange }}</option>
                        <option value="pink">ğŸŒ¸ {{ texts.pink }}</option>
                        <option value="teal">ğŸ”· {{ texts.cyan }}</option>
                        <option value="sunset">ğŸŒ… {{ texts.sunset }}</option>
                        <option value="ocean">ğŸŒŠ {{ texts.ocean }}</option>
                        <option value="forest">ğŸŒ² {{ texts.forest }}</option>
                    </select>
                </div>
            </div>

            <!-- æ‹–æ‹½é…ç½®åŒºåŸŸï¼ˆè¡¨æ ¼ï¼‰ -->
            <div class="drag-config-area" id="dragConfigAreaTable" style="display: none;">
                <!-- è¡ŒåŒºåŸŸ -->
                <div class="drop-zone-container">
                    <label class="drop-zone-label" data-text-key="rows">{{ texts.rows }}</label>
                    <div class="drop-zone" id="rowsDropZone" ondrop="drop(event, 'rows')" ondragover="allowDrop(event)">
                        <span class="drop-hint" data-text-key="drag_field_here">{{ texts.drag_field_here }}</span>
                    </div>
                </div>

                <!-- åˆ—åŒºåŸŸ -->
                <div class="drop-zone-container">
                    <label class="drop-zone-label" data-text-key="columns">{{ texts.columns }}</label>
                    <div class="drop-zone" id="columnsDropZone" ondrop="drop(event, 'columns')" ondragover="allowDrop(event)">
                        <span class="drop-hint" data-text-key="drag_field_here">{{ texts.drag_field_here }}</span>
                    </div>
                </div>

                <!-- å€¼åŒºåŸŸ -->
                <div class="drop-zone-container">
                    <label class="drop-zone-label" data-text-key="values">{{ texts['values'] }}</label>
                    <div class="drop-zone" id="valuesDropZone" ondrop="drop(event, 'values')" ondragover="allowDrop(event)">
                        <span class="drop-hint" data-text-key="drag_field_here">{{ texts.drag_field_here }}</span>
                    </div>
                </div>

                <!-- ç”Ÿæˆè¡¨æ ¼æŒ‰é’® -->
                <div class="generate-btn-container">
                    <button class="btn btn-generate" id="generateBtn" onclick="generateTable()">
                        ğŸš€ {{ texts.generate_table }}
                    </button>
                </div>
            </div>

            <!-- æ‹–æ‹½é…ç½®åŒºåŸŸï¼ˆè”åˆå›¾ï¼‰ -->
            <div class="drag-config-area drag-config-combo" id="dragConfigAreaCombo" style="display: none;">
                <!-- ç»´åº¦åŒºåŸŸ -->
                <div class="drop-zone-container" style="grid-column: 1 / -1;">
                    <label class="drop-zone-label">ç»´åº¦ï¼ˆXè½´ï¼‰</label>
                    <div class="drop-zone" id="comboDimensionDropZone" ondrop="drop(event, 'combo_dimension')" ondragover="allowDrop(event)">
                        <span class="drop-hint">å°†ç»´åº¦å­—æ®µæ‹–åˆ°æ­¤å¤„</span>
                    </div>
                </div>

                <!-- åº¦é‡åŒºåŸŸ -->
                <div class="drop-zone-container combo-measures-container" style="grid-column: 1 / -1;">
                    <label class="drop-zone-label">åº¦é‡ï¼ˆYè½´ï¼‰- å¯æ‹–æ‹½å¤šä¸ª</label>
                    <div class="drop-zone drop-zone-multi" id="comboMeasuresDropZone" ondrop="drop(event, 'combo_measures')" ondragover="allowDrop(event)">
                        <span class="drop-hint">å°†åº¦é‡å­—æ®µæ‹–åˆ°æ­¤å¤„ï¼ˆæ”¯æŒå¤šä¸ªï¼‰</span>
                    </div>
                </div>

                <!-- ç”Ÿæˆå›¾è¡¨æŒ‰é’® -->
                <div class="generate-btn-container" style="grid-column: 1 / -1;">
                    <button class="btn btn-generate" onclick="generateComboChart()">
                        ğŸ¨ ç”Ÿæˆè”åˆå›¾
                    </button>
                </div>
            </div>

            <!-- æ‹–æ‹½é…ç½®åŒºåŸŸï¼ˆè¯äº‘å›¾ï¼‰ -->
            <div class="drag-config-area drag-config-wordcloud" id="dragConfigAreaWordcloud" style="display: none;">
                <!-- æ–‡æœ¬å­—æ®µåŒºåŸŸ -->
                <div class="drop-zone-container">
                    <label class="drop-zone-label" data-text-key="text_field">{{ texts.text_field }}</label>
                    <div class="drop-zone" id="wordcloudTextDropZone" ondrop="drop(event, 'wordcloud_text')" ondragover="allowDrop(event)">
                        <span class="drop-hint" data-text-key="drag_text_field_required">{{ texts.drag_text_field_required }}</span>
                    </div>
                </div>

                <!-- æƒé‡å­—æ®µåŒºåŸŸ -->
                <div class="drop-zone-container">
                    <label class="drop-zone-label" data-text-key="weight_field_optional">{{ texts.weight_field_optional }}</label>
                    <div class="drop-zone" id="wordcloudWeightDropZone" ondrop="drop(event, 'wordcloud_weight')" ondragover="allowDrop(event)">
                        <span class="drop-hint" data-text-key="drag_weight_field_optional">{{ texts.drag_weight_field_optional }}</span>
                    </div>
                </div>

                <!-- å½¢çŠ¶é€‰æ‹©åŒºåŸŸ -->
                <div class="drop-zone-container">
                    <label class="drop-zone-label" data-text-key="wordcloud_shape" id="wordcloudShapeLabel">{{ texts.wordcloud_shape }}</label>
                    <select id="wordcloudShapeSelect" class="config-select">
                        <option value="rectangle">ğŸ“ {{ texts.shape_rectangle }}</option>
                        <option value="circle">â­• {{ texts.shape_circle }}</option>
                        <option value="cloud">â˜ï¸ {{ texts.shape_cloud }}</option>
                        <option value="star">â­ {{ texts.shape_star }}</option>
                        <option value="heart">â¤ï¸ {{ texts.shape_heart }}</option>
                        <option value="diamond">ğŸ’ {{ texts.shape_diamond }}</option>
                    </select>
                </div>

                <!-- ç”Ÿæˆå›¾è¡¨æŒ‰é’® -->
                <div class="generate-btn-container" style="grid-column: 1 / -1;">
                    <button class="btn btn-generate" id="generateWordcloudBtn" onclick="generateWordcloud()">
                        ğŸ¨ <span id="generateWordcloudText">{{ texts.generate_wordcloud }}</span>
                    </button>
                </div>
            </div>

            <!-- æ‹–æ‹½é…ç½®åŒºåŸŸï¼ˆå›¾è¡¨ï¼‰ -->
            <div class="drag-config-area drag-config-chart" id="dragConfigAreaChart" style="display: none;">
                <!-- Xè½´åŒºåŸŸ -->
                <div class="drop-zone-container">
                    <label class="drop-zone-label" id="xAxisLabel">Xè½´ï¼ˆç»´åº¦ï¼‰</label>
                    <div class="drop-zone" id="xAxisDropZone" ondrop="drop(event, 'x_axis')" ondragover="allowDrop(event)">
                        <span class="drop-hint" id="xAxisHint">å°†ç»´åº¦å­—æ®µæ‹–åˆ°æ­¤å¤„</span>
                    </div>
                </div>

                <!-- Yè½´åŒºåŸŸ -->
                <div class="drop-zone-container">
                    <label class="drop-zone-label" id="yAxisLabel">Yè½´ï¼ˆåº¦é‡ï¼‰</label>
                    <div class="drop-zone" id="yAxisDropZone" ondrop="drop(event, 'y_axis')" ondragover="allowDrop(event)">
                        <span class="drop-hint" id="yAxisHint">å°†åº¦é‡å­—æ®µæ‹–åˆ°æ­¤å¤„</span>
                    </div>
                </div>
                
                <!-- åˆ†ç»„å­—æ®µåŒºåŸŸï¼ˆä»…æ•£ç‚¹å›¾æ˜¾ç¤ºï¼‰ -->
                <div class="drop-zone-container" id="groupFieldContainer" style="display: none; grid-column: 1 / -1;">
                    <label class="drop-zone-label">å¤§å°å­—æ®µï¼ˆå¯é€‰ï¼‰</label>
                    <div class="drop-zone" id="groupFieldDropZone" ondrop="drop(event, 'group_field')" ondragover="allowDrop(event)">
                        <span class="drop-hint">å°†åº¦é‡å­—æ®µæ‹–åˆ°æ­¤å¤„ï¼Œç”¨ç‚¹çš„å¤§å°è¡¨ç¤ºæ•°å€¼</span>
                    </div>
                </div>

                <!-- æ–‡å­—å·¥å…·æŒ‰é’® -->
                <div class="text-tool-container" style="grid-column: 1 / -1;">
                    <button class="btn-text-tool" onclick="toggleTextOptions()" title="æ·»åŠ æ–‡å­—æ ‡ç­¾">
                        <span class="text-tool-icon">T</span> æ–‡å­—æ ‡ç­¾
                    </button>
                </div>

                <!-- æ–‡å­—é…ç½®é€‰é¡¹ï¼ˆæŠ˜å ï¼‰ -->
                <div class="text-options-panel" id="textOptionsPanel" style="display: none; grid-column: 1 / -1;">
                    <div class="text-option-item">
                        <label class="text-option-label">
                            <input type="checkbox" id="enableTitle" onchange="toggleTextInput('title')"> æ ‡é¢˜
                        </label>
                        <input type="text" id="titleInput" class="text-input" placeholder="è¾“å…¥æ ‡é¢˜å†…å®¹" disabled>
                    </div>
                    <div class="text-option-item">
                        <label class="text-option-label">
                            <input type="checkbox" id="enableXLabel" onchange="toggleTextInput('xlabel')"> æ¨ªè½´æ ‡ç­¾
                        </label>
                        <input type="text" id="xlabelInput" class="text-input" placeholder="è¾“å…¥æ¨ªè½´æ ‡ç­¾" disabled>
                    </div>
                    <div class="text-option-item">
                        <label class="text-option-label">
                            <input type="checkbox" id="enableYLabel" onchange="toggleTextInput('ylabel')"> çºµè½´æ ‡ç­¾
                        </label>
                        <input type="text" id="ylabelInput" class="text-input" placeholder="è¾“å…¥çºµè½´æ ‡ç­¾" disabled>
                    </div>
                </div>

                <!-- ç”Ÿæˆå›¾è¡¨æŒ‰é’® -->
                <div class="generate-btn-container" style="grid-column: 1 / -1;">
                    <button class="btn btn-generate" onclick="generateChart()">
                        ğŸ¨ ç”Ÿæˆå›¾è¡¨
                    </button>
                </div>
            </div>

            <!-- è¡¨æ ¼æ˜¾ç¤ºåŒºåŸŸ -->
            <div class="table-display-area" id="tableDisplayArea">
                <div class="placeholder">
                    <div class="placeholder-icon">ğŸ“Š</div>
                    <p id="tableDisplayPlaceholder">{{ texts.select_file_drag_field_to_create }}</p>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- æ•°æ®é¢„è§ˆå¼¹çª— -->
<div class="modal-overlay" id="previewModal" style="display: none;" onclick="closePreviewModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h2 id="modalFileName">æ•°æ®é¢„è§ˆ</h2>
            <button class="modal-close-btn" onclick="closePreviewModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="modal-info">
                <span id="modalFileInfo">åŠ è½½ä¸­...</span>
            </div>
            <div class="modal-table-wrapper" id="modalTableWrapper">
                <!-- è¡¨æ ¼å†…å®¹å°†é€šè¿‡JavaScriptå¡«å…… -->
            </div>
        </div>
    </div>
</div>

<!-- åº¦é‡é…ç½®å¼¹çª—ï¼ˆè”åˆå›¾ï¼‰ -->
<div class="modal-overlay" id="measureConfigModal" style="display: none;" onclick="closeMeasureConfig(event)">
    <div class="modal-content axis-config-modal" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h2 id="measureConfigTitle">åº¦é‡é…ç½®</h2>
            <button class="modal-close-btn" onclick="closeMeasureConfig()">&times;</button>
        </div>
        <div class="modal-body axis-config-body">
            <!-- å›¾è¡¨ç±»å‹ -->
            <div class="config-section">
                <label class="config-label">å›¾è¡¨ç±»å‹</label>
                <select id="measureChartType" class="config-select">
                    <option value="bar">ğŸ“Š æŸ±çŠ¶å›¾</option>
                    <option value="line">ğŸ“ˆ æŠ˜çº¿å›¾</option>
                    <option value="area">ğŸ“Š é¢ç§¯å›¾</option>
                </select>
            </div>

            <!-- èšåˆæ–¹å¼ -->
            <div class="config-section">
                <label class="config-label">èšåˆæ–¹å¼</label>
                <select id="measureAggregation" class="config-select">
                    <option value="sum">æ±‚å’Œ</option>
                    <option value="avg">å¹³å‡å€¼</option>
                    <option value="count">è®¡æ•°</option>
                    <option value="max">æœ€å¤§å€¼</option>
                    <option value="min">æœ€å°å€¼</option>
                </select>
            </div>

            <!-- æŒ‰é’® -->
            <div class="config-buttons">
                <button class="btn btn-secondary" onclick="closeMeasureConfig()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveMeasureConfig()">ç¡®å®š</button>
            </div>
        </div>
    </div>
</div>

<!-- è½´é…ç½®å¼¹çª— -->
<div class="modal-overlay" id="axisConfigModal" style="display: none;" onclick="closeAxisConfig(event)">
    <div class="modal-content axis-config-modal" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h2 id="axisConfigTitle">è½´è®¾ç½®</h2>
            <button class="modal-close-btn" onclick="closeAxisConfig()">&times;</button>
        </div>
        <div class="modal-body axis-config-body">
            <!-- èšåˆæ–¹å¼ -->
            <div class="config-section">
                <label class="config-label">åº¦é‡</label>
                <select id="axisAggregation" class="config-select">
                    <option value="sum">æ±‚å’Œ</option>
                    <option value="avg">å¹³å‡å€¼</option>
                    <option value="count">è®¡æ•°</option>
                    <option value="max">æœ€å¤§å€¼</option>
                    <option value="min">æœ€å°å€¼</option>
                </select>
            </div>

            <!-- æ’åºæ–¹å¼ -->
            <div class="config-section">
                <label class="config-label">æ’åºæ–¹å¼</label>
                <select id="axisSort" class="config-select">
                    <option value="none">æ— </option>
                    <option value="asc">å‡åº</option>
                    <option value="desc">é™åº</option>
                </select>
            </div>

            <!-- æ•°æ®æ ¼å¼ -->
            <div class="config-section">
                <label class="config-label">æ•°æ®æ ¼å¼</label>
                <select id="axisFormat" class="config-select">
                    <option value="number">æ•°å­—</option>
                    <option value="percent">ç™¾åˆ†æ¯”</option>
                    <option value="currency">è´§å¸ï¼ˆï¿¥ï¼‰</option>
                </select>
            </div>

            <!-- è½´åç§° -->
            <div class="config-section">
                <label class="config-label">è½´åç§°ï¼ˆå¯é€‰ï¼‰</label>
                <input type="text" id="axisName" class="config-input" placeholder="ç•™ç©ºåˆ™ä½¿ç”¨å­—æ®µå">
            </div>

            <!-- å¯¹æ•°è½´ -->
            <div class="config-section">
                <label class="config-label">å¯¹æ•°è½´</label>
                <div class="config-radio-group">
                    <label class="config-radio">
                        <input type="radio" name="logScale" value="false" checked> å…³
                    </label>
                    <label class="config-radio">
                        <input type="radio" name="logScale" value="true"> å¼€
                    </label>
                </div>
            </div>

            <!-- æŒ‰é’® -->
            <div class="config-buttons">
                <button class="btn btn-secondary" onclick="closeAxisConfig()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveAxisConfig()">ç¡®å®š</button>
            </div>
        </div>
    </div>
</div>

<script>
// å½“å‰è¯­è¨€
var currentLanguage = '{{ lang }}';
var allTexts = {{ texts | tojson }};

// åˆ‡æ¢è¯­è¨€ï¼ˆæ— åˆ·æ–°ï¼‰
function switchLanguage(lang) {
    if (lang === currentLanguage) return;
    
    fetch('/api/set_language/' + lang, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentLanguage = lang;
            allTexts = data.texts;
            updatePageTexts();
            updateLanguageButtons();
        }
    })
    .catch(error => {
        console.error('è¯­è¨€åˆ‡æ¢å¤±è´¥:', error);
    });
}

// æ›´æ–°è¯­è¨€æŒ‰é’®çŠ¶æ€
function updateLanguageButtons() {
    document.getElementById('lang-btn-zh').classList.toggle('active', currentLanguage === 'zh');
    document.getElementById('lang-btn-en').classList.toggle('active', currentLanguage === 'en');
}

// æ›´æ–°é¡µé¢æ–‡æœ¬
function updatePageTexts() {
    // æ›´æ–°headeræ ‡é¢˜
    document.querySelector('.header-title').textContent = allTexts.app_title;
    
    // æ›´æ–°æŒ‰é’®æ–‡æœ¬
    const dashboardBtn = document.querySelector('.btn-dashboard-mode');
    if (dashboardBtn) {
        dashboardBtn.innerHTML = 'ğŸ“Š ' + allTexts.dashboard_mode;
        dashboardBtn.title = allTexts.switch_to_dashboard;
    }
    
    // æ›´æ–°æ¬¢è¿æ–‡æœ¬
    const welcomeText = document.querySelector('.welcome-text');
    if (welcomeText) {
        const username = welcomeText.textContent.split('ï¼Œ')[1] || welcomeText.textContent.split(', ')[1];
        welcomeText.textContent = allTexts.welcome + (currentLanguage === 'zh' ? 'ï¼Œ' : ', ') + username;
    }
    
    // æ›´æ–°æ³¨é”€æŒ‰é’®
    document.querySelector('.btn-logout').textContent = allTexts.logout;
    
    // æ›´æ–°å·¦ä¾§è¾¹æ æ ‡é¢˜
    document.querySelectorAll('.section-title').forEach((el, index) => {
        if (index === 0) el.innerHTML = '<span class="icon">ğŸ“Š</span>' + allTexts.data;
        if (index === 1) el.innerHTML = '<span class="icon">ğŸ“</span>' + allTexts.fields;
    });
    
    // æ›´æ–°ä¸Šä¼ æŒ‰é’®
    const uploadBtn = document.querySelector('.btn-upload');
    if (uploadBtn) {
        uploadBtn.innerHTML = '<span>ğŸ“</span> ' + allTexts.upload_file;
    }
    
    // æ›´æ–°æç¤ºæ–‡æœ¬
    const uploadHint = document.querySelector('.upload-hint');
    if (uploadHint) {
        uploadHint.textContent = allTexts.support_formats;
    }
    
    // æ›´æ–°æ–‡ä»¶é€‰æ‹©æ ‡é¢˜
    const fileSelectorTitle = document.querySelector('.file-selector-title');
    if (fileSelectorTitle) {
        fileSelectorTitle.textContent = allTexts.select_data_source;
    }
    
    // æ›´æ–°ä¸‹æ‹‰æ¡†é»˜è®¤é€‰é¡¹
    const fileSelector = document.getElementById('fileSelector');
    if (fileSelector && fileSelector.options[0]) {
        fileSelector.options[0].text = allTexts.please_select_file;
    }
    
    // æ›´æ–°ç»´åº¦/åº¦é‡æ ‡é¢˜
    const columnGroupTitles = document.querySelectorAll('.column-group-title');
    columnGroupTitles.forEach((el) => {
        const text = el.textContent.trim();
        if (text.includes('ç»´åº¦') || text.includes('Dimensions')) {
            el.innerHTML = '<span class="collapse-icon" onclick="toggleGroup(\'dimensions\')">â–¼</span>' + allTexts.dimensions;
        } else if (text.includes('åº¦é‡') || text.includes('Measures')) {
            el.innerHTML = '<span class="collapse-icon" onclick="toggleGroup(\'measures\')">â–¼</span>' + allTexts.measures;
        }
    });
    
    // æ›´æ–°é¢„è§ˆå’Œåˆ é™¤æŒ‰é’®
    const previewBtn = document.querySelector('.btn-preview');
    if (previewBtn) {
        previewBtn.innerHTML = 'ğŸ‘ï¸ ' + allTexts.preview;
    }
    
    const deleteFileBtn = document.querySelector('.btn-delete-file');
    if (deleteFileBtn) {
        deleteFileBtn.innerHTML = 'ğŸ—‘ï¸ ' + allTexts.delete;
    }
    
    // æ›´æ–°ç”ŸæˆæŒ‰é’®
    const generateBtn = document.getElementById('generateBtn');
    if (generateBtn) {
        const isTable = currentVisualizationType === 'list' || currentVisualizationType === 'cross';
        generateBtn.innerHTML = 'ğŸš€ ' + (isTable ? allTexts.generate_table : allTexts.generate_chart);
    }
    
    // æ›´æ–°å¯è§†åŒ–ç±»å‹æ ‡ç­¾
    const visTypeLabel = document.getElementById('visTypeLabel');
    if (visTypeLabel) {
        visTypeLabel.textContent = allTexts.visualization_type + 'ï¼š';
    }
    
    // æ›´æ–°ä¸»é¢˜æ ‡ç­¾
    const themeLabel = document.getElementById('themeLabel');
    if (themeLabel) {
        themeLabel.textContent = allTexts.theme + 'ï¼š';
    }
    
    // æ›´æ–°å¯è§†åŒ–ç±»å‹ä¸‹æ‹‰é€‰é¡¹
    const visTypeSelect = document.getElementById('visualizationTypeSelect');
    if (visTypeSelect) {
        visTypeSelect.options[0].text = 'ğŸ“‹ ' + allTexts.list_table;
        visTypeSelect.options[1].text = 'ğŸ“Š ' + allTexts.cross_table;
        visTypeSelect.options[2].text = 'ğŸ“ˆ ' + allTexts.line_chart;
        visTypeSelect.options[3].text = 'ğŸ“Š ' + allTexts.area_chart;
        visTypeSelect.options[4].text = 'ğŸ¥§ ' + allTexts.pie_chart;
        visTypeSelect.options[5].text = 'ğŸ“Š ' + allTexts.bar_chart;
        visTypeSelect.options[6].text = 'ğŸ“ˆ ' + allTexts.waterfall_chart;
        visTypeSelect.options[7].text = 'ğŸ”µ ' + allTexts.scatter_chart;
        visTypeSelect.options[8].text = 'ğŸ“Š ' + allTexts.combo_single;
        visTypeSelect.options[9].text = 'ğŸ“Š ' + allTexts.combo_dual;
        visTypeSelect.options[10].text = 'â˜ï¸ ' + allTexts.wordcloud;
        visTypeSelect.options[11].text = 'â˜€ï¸ ' + allTexts.sunburst;
        visTypeSelect.options[12].text = 'ğŸ—ºï¸ ' + allTexts.map;
    }
    
    // æ›´æ–°ä¸»é¢˜ä¸‹æ‹‰é€‰é¡¹
    const themeSelect = document.getElementById('themeSelect');
    if (themeSelect) {
        themeSelect.options[0].text = 'ğŸŸ£ ' + allTexts.purple;
        themeSelect.options[1].text = 'ğŸ”µ ' + allTexts.blue;
        themeSelect.options[2].text = 'ğŸŸ¢ ' + allTexts.green;
        themeSelect.options[3].text = 'ğŸ”´ ' + allTexts.red;
        themeSelect.options[4].text = 'ğŸŸ  ' + allTexts.orange;
        themeSelect.options[5].text = 'ğŸŒ¸ ' + allTexts.pink;
        themeSelect.options[6].text = 'ğŸ”· ' + allTexts.cyan;
        themeSelect.options[7].text = 'ğŸŒ… ' + allTexts.sunset;
        themeSelect.options[8].text = 'ğŸŒŠ ' + allTexts.ocean;
        themeSelect.options[9].text = 'ğŸŒ² ' + allTexts.forest;
    }
    
    // æ›´æ–°æ‰€æœ‰å¸¦data-text-keyå±æ€§çš„å…ƒç´ 
    document.querySelectorAll('[data-text-key]').forEach(el => {
        const key = el.getAttribute('data-text-key');
        if (allTexts[key]) {
            el.textContent = allTexts[key];
        }
    });
    
    // æ›´æ–°å›¾è¡¨åˆ›å»ºåŒºæ–‡æœ¬
    const chartCreateTitle = document.getElementById('chartCreateTitle');
    if (chartCreateTitle) chartCreateTitle.textContent = allTexts.chart_creation_zone;
    
    const chartCreateHint = document.getElementById('chartCreateHint');
    if (chartCreateHint) chartCreateHint.textContent = allTexts.drag_file_to_create;
    
    // æ›´æ–°è¯äº‘å›¾é…ç½®åŒºåŸŸ
    const wordcloudShapeSelect = document.getElementById('wordcloudShapeSelect');
    if (wordcloudShapeSelect && wordcloudShapeSelect.options.length >= 6) {
        wordcloudShapeSelect.options[0].text = 'ğŸ“ ' + allTexts.shape_rectangle;
        wordcloudShapeSelect.options[1].text = 'â­• ' + allTexts.shape_circle;
        wordcloudShapeSelect.options[2].text = 'â˜ï¸ ' + allTexts.shape_cloud;
        wordcloudShapeSelect.options[3].text = 'â­ ' + allTexts.shape_star;
        wordcloudShapeSelect.options[4].text = 'â¤ï¸ ' + allTexts.shape_heart;
        wordcloudShapeSelect.options[5].text = 'ğŸ’ ' + allTexts.shape_diamond;
    }
    
    const generateWordcloudText = document.getElementById('generateWordcloudText');
    if (generateWordcloudText) generateWordcloudText.textContent = allTexts.generate_wordcloud;
    
    // æ›´æ–°è¡¨æ ¼æ˜¾ç¤ºåŒºåŸŸå ä½ç¬¦
    const tableDisplayPlaceholder = document.getElementById('tableDisplayPlaceholder');
    if (tableDisplayPlaceholder) tableDisplayPlaceholder.textContent = allTexts.select_file_drag_field_to_create;
}

// å½“å‰é€‰ä¸­çš„æ–‡ä»¶IDå’Œå¯è§†åŒ–ç±»å‹
let selectedFileId = null;
let currentVisualizationType = 'list';  // 'list', 'cross', 'bar', 'waterfall'
let currentChartFilename = null;  // å½“å‰å›¾è¡¨æ–‡ä»¶å
let currentTheme = 'purple'; // é»˜è®¤ä¸»é¢˜

// ä¸»é¢˜é¢œè‰²é…ç½®
const themeColors = {
    purple: {
        name: 'ç´«è‰²ç³»',
        primary: '#667eea',
        secondary: '#764ba2',
        gradient: ['#667eea', '#764ba2'],
        multi: ['#9b87f5', '#7c6fd6', '#667eea', '#5757d8', '#4641c6']
    },
    blue: {
        name: 'è“è‰²ç³»',
        primary: '#4299e1',
        secondary: '#2b6cb0',
        gradient: ['#4299e1', '#2b6cb0'],
        multi: ['#90cdf4', '#63b3ed', '#4299e1', '#3182ce', '#2c5282']
    },
    green: {
        name: 'ç»¿è‰²ç³»',
        primary: '#48bb78',
        secondary: '#2f855a',
        gradient: ['#48bb78', '#2f855a'],
        multi: ['#9ae6b4', '#68d391', '#48bb78', '#38a169', '#2f855a']
    },
    red: {
        name: 'çº¢è‰²ç³»',
        primary: '#f56565',
        secondary: '#c53030',
        gradient: ['#f56565', '#c53030'],
        multi: ['#fc8181', '#f56565', '#e53e3e', '#c53030', '#9b2c2c']
    },
    orange: {
        name: 'æ©™è‰²ç³»',
        primary: '#ed8936',
        secondary: '#c05621',
        gradient: ['#ed8936', '#c05621'],
        multi: ['#fbd38d', '#f6ad55', '#ed8936', '#dd6b20', '#c05621']
    },
    pink: {
        name: 'ç²‰è‰²ç³»',
        primary: '#ed64a6',
        secondary: '#b83280',
        gradient: ['#ed64a6', '#b83280'],
        multi: ['#fbb6ce', '#f687b3', '#ed64a6', '#d53f8c', '#b83280']
    },
    teal: {
        name: 'é’è‰²ç³»',
        primary: '#38b2ac',
        secondary: '#2c7a7b',
        gradient: ['#38b2ac', '#2c7a7b'],
        multi: ['#81e6d9', '#4fd1c5', '#38b2ac', '#319795', '#2c7a7b']
    },
    sunset: {
        name: 'æ—¥è½æ¸å˜',
        primary: '#f093fb',
        secondary: '#f5576c',
        gradient: ['#f093fb', '#f5576c'],
        multi: ['#fbc2eb', '#f093fb', '#f57b94', '#f5576c', '#d63447']
    },
    ocean: {
        name: 'æµ·æ´‹æ¸å˜',
        primary: '#667eea',
        secondary: '#00c9ff',
        gradient: ['#667eea', '#00c9ff'],
        multi: ['#8b9aed', '#667eea', '#4395e6', '#00b9e3', '#00c9ff']
    },
    forest: {
        name: 'æ£®æ—æ¸å˜',
        primary: '#56ab2f',
        secondary: '#a8e063',
        gradient: ['#56ab2f', '#a8e063'],
        multi: ['#6bc248', '#56ab2f', '#75b94d', '#92c96e', '#a8e063']
    }
};

// æ‹–æ‹½é…ç½®ï¼ˆè¡¨æ ¼ï¼‰
let dragConfig = {
    rows: [],
    columns: [],
    values: []
};

// æ‹–æ‹½é…ç½®ï¼ˆå›¾è¡¨ï¼‰
let chartConfig = {
    x_axis: null,
    y_axis: null,
    group_field: null,  // æ•£ç‚¹å›¾åˆ†ç»„å­—æ®µ
    // è½´é…ç½®
    x_axis_config: {
        aggregation: 'sum',  // èšåˆæ–¹å¼ï¼šsum, avg, count, max, min
        sort: 'none',        // æ’åºï¼šnone, asc, desc
        format: 'number',    // æ ¼å¼ï¼šnumber, percent, currency
        log_scale: false,    // å¯¹æ•°è½´
        axis_name: ''        // è‡ªå®šä¹‰è½´åç§°
    },
    y_axis_config: {
        aggregation: 'sum',
        sort: 'none',
        format: 'number',
        log_scale: false,
        axis_name: ''
    }
};

// æ‹–æ‹½é…ç½®ï¼ˆè”åˆå›¾ï¼‰
let comboConfig = {
    dimension: null,  // ç»´åº¦å­—æ®µï¼ˆXè½´ï¼‰
    measures: []      // åº¦é‡å­—æ®µæ•°ç»„ï¼Œæ¯ä¸ªåº¦é‡åŒ…å«å­—æ®µåå’Œå›¾è¡¨ç±»å‹
};

// è¯äº‘å›¾é…ç½®
let wordcloudConfig = {
    text_field: null,   // æ–‡æœ¬å­—æ®µ
    weight_field: null  // æƒé‡å­—æ®µï¼ˆå¯é€‰ï¼‰
};

// ä¸Šä¼ æ–‡ä»¶
function uploadFile(input) {
    const file = input.files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append('file', file);

    showLoading('æ­£åœ¨ä¸Šä¼ æ–‡ä»¶...');

    fetch('/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            location.reload();
        } else {
            alert('ä¸Šä¼ å¤±è´¥: ' + data.message);
        }
    })
    .catch(error => {
        hideLoading();
        alert('ä¸Šä¼ å¤±è´¥: ' + error.message);
    });

    input.value = '';
}

// æ–‡ä»¶æ‹–æ‹½å¼€å§‹
let draggedFileId = null;

function dragFileStart(event, fileId) {
    draggedFileId = fileId;
    event.dataTransfer.effectAllowed = 'move';
    event.currentTarget.classList.add('dragging-file');
}

function dragFileEnd(event) {
    event.currentTarget.classList.remove('dragging-file');
}

// å…è®¸æ”¾ç½®æ–‡ä»¶åˆ°åˆ›å»ºåŒº
function allowDropFile(event) {
    event.preventDefault();
    event.currentTarget.classList.add('drag-over-create');
}

function leaveDropFile(event) {
    event.currentTarget.classList.remove('drag-over-create');
}

// æ”¾ç½®æ–‡ä»¶åˆ°åˆ›å»ºåŒº
function dropFileToCreate(event) {
    event.preventDefault();
    event.currentTarget.classList.remove('drag-over-create');
    
    if (draggedFileId) {
        // ç›´æ¥åˆ‡æ¢æ–‡ä»¶ï¼Œä¸å†è¯¢é—®ç¡®è®¤
        selectFile(draggedFileId);
        draggedFileId = null;
    }
}

// å¤„ç†æ–‡ä»¶é€‰æ‹©ä¸‹æ‹‰æ¡†å˜åŒ–
function handleFileSelect(fileId) {
    if (!fileId) return; // å¦‚æœé€‰æ‹©çš„æ˜¯é»˜è®¤é€‰é¡¹ï¼Œä¸åšå¤„ç†
    
    const fileIdInt = parseInt(fileId);
    
    // ç›´æ¥åˆ‡æ¢æ–‡ä»¶ï¼Œä¸å†è¯¢é—®ç¡®è®¤
    selectFile(fileIdInt);
}

// é¢„è§ˆé€‰ä¸­çš„æ–‡ä»¶
function previewSelectedFile() {
    const selector = document.getElementById('fileSelector');
    const fileId = selector.value;
    
    if (!fileId) {
        alert(allTexts.please_select_file_first);
        return;
    }
    
    showFilePreview(parseInt(fileId));
}

// åˆ é™¤é€‰ä¸­çš„æ–‡ä»¶
function deleteSelectedFile() {
    const selector = document.getElementById('fileSelector');
    const fileId = selector.value;
    
    if (!fileId) {
        alert(allTexts.please_select_file_first);
        return;
    }
    
    deleteFile(parseInt(fileId));
}

// å¤„ç†æ–‡ä»¶ç‚¹å‡»äº‹ä»¶ï¼ˆæ—§ç‰ˆï¼Œä¿ç•™å…¼å®¹ï¼‰
let clickTimer = null;
function handleFileClick(event, fileId) {
    // é˜»æ­¢æ‹–åŠ¨æ—¶è§¦å‘ç‚¹å‡»
    if (event.detail === 0) return;
    
    // å¦‚æœåŒå‡»ï¼Œæ¸…é™¤å•å‡»è®¡æ—¶å™¨
    clearTimeout(clickTimer);
    
    // è®¾ç½®å•å‡»å»¶è¿Ÿï¼ˆé¿å…åŒå‡»æ—¶è§¦å‘å•å‡»ï¼‰
    clickTimer = setTimeout(() => {
        if (selectedFileId && selectedFileId !== fileId) {
            // ç›´æ¥åˆ‡æ¢æ–‡ä»¶ï¼Œä¸å†è¯¢é—®ç¡®è®¤
            selectFile(fileId);
        } else if (!selectedFileId) {
            // é¦–æ¬¡ç‚¹å‡»ï¼Œæ˜¾ç¤ºé¢„è§ˆ
            showFilePreview(fileId);
        }
    }, 250); // 250mså»¶è¿Ÿï¼Œå¦‚æœæ˜¯åŒå‡»åˆ™ä¼šè¢«æ¸…é™¤
}

// é€‰æ‹©æ–‡ä»¶ï¼ˆå¼€å§‹åˆ›å»ºå›¾è¡¨ï¼‰
function selectFile(fileId) {
    selectedFileId = fileId;

    // éšè—åˆ›å»ºåŒº
    document.getElementById('chartCreateZone').style.display = 'none';
    
    // æ›´æ–°ä¸‹æ‹‰æ¡†é€‰ä¸­çŠ¶æ€
    const selector = document.getElementById('fileSelector');
    if (selector) {
        selector.value = fileId;
    }
    
    // é«˜äº®é€‰ä¸­çš„æ–‡ä»¶ï¼ˆå¦‚æœä½¿ç”¨æ—§ç‰ˆåˆ—è¡¨ï¼‰
    document.querySelectorAll('.file-item').forEach(item => {
        item.classList.remove('selected');
    });
    const fileItem = document.querySelector(`[data-file-id="${fileId}"]`);
    if (fileItem) {
        fileItem.classList.add('selected');
    }

    loadFileColumns(fileId);
    
    // æ˜¾ç¤ºå¯è§†åŒ–ç±»å‹é€‰æ‹©å™¨
    document.getElementById('tableTypeSelector').style.display = 'flex';
    
    // ç¡®ä¿ä¸‹æ‹‰æ¡†æœ‰é»˜è®¤å€¼ï¼ˆæ¸…å•è¡¨ï¼‰
    const visSelect = document.getElementById('visualizationTypeSelect');
    if (visSelect && !currentVisualizationType) {
        currentVisualizationType = 'list';
        visSelect.value = 'list';
    } else if (visSelect) {
        visSelect.value = currentVisualizationType;
    }
    
    // æ ¹æ®å½“å‰ç±»å‹æ˜¾ç¤ºå¯¹åº”çš„é…ç½®åŒºåŸŸ
    updateConfigArea();
    
    // æ¸…ç©ºä¹‹å‰çš„é…ç½®
    resetAllConfig();
}

// æ˜¾ç¤ºæ–‡ä»¶é¢„è§ˆå¼¹çª—
function showFilePreview(fileId) {
    showLoading('æ­£åœ¨åŠ è½½æ•°æ®...');
    
    fetch(`/api/file/${fileId}/preview`)
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            displayPreviewModal(data);
        } else {
            alert('åŠ è½½å¤±è´¥: ' + data.message);
        }
    })
    .catch(error => {
        hideLoading();
        alert('åŠ è½½å¤±è´¥: ' + error.message);
    });
}

// æ˜¾ç¤ºé¢„è§ˆå¼¹çª—å†…å®¹
function displayPreviewModal(data) {
    document.getElementById('modalFileName').textContent = data.filename;
    document.getElementById('modalFileInfo').textContent = 
        `å…± ${data.total_rows} è¡Œ Ã— ${data.total_columns} åˆ—ï¼Œæ˜¾ç¤ºå‰ ${data.displayed_rows} è¡Œ`;
    
    let html = '<table class="preview-table">';
    
    // è¡¨å¤´
    html += '<thead><tr>';
    data.columns.forEach(col => {
        html += `<th>${col}</th>`;
    });
    html += '</tr></thead>';
    
    // è¡¨ä½“
    html += '<tbody>';
    data.data.forEach(row => {
        html += '<tr>';
        row.forEach(cell => {
            const displayValue = typeof cell === 'number' ? cell.toLocaleString() : cell;
            html += `<td>${displayValue}</td>`;
        });
        html += '</tr>';
    });
    html += '</tbody>';
    
    html += '</table>';
    
    document.getElementById('modalTableWrapper').innerHTML = html;
    document.getElementById('previewModal').style.display = 'flex';
}

// å…³é—­é¢„è§ˆå¼¹çª—
function closePreviewModal(event) {
    if (!event || event.target.id === 'previewModal' || event.target.className === 'modal-close-btn') {
        document.getElementById('previewModal').style.display = 'none';
    }
}

// åŠ è½½æ–‡ä»¶åˆ—ä¿¡æ¯
function loadFileColumns(fileId) {
    showLoading('æ­£åœ¨åŠ è½½æ•°æ®...');

    fetch(`/api/file/${fileId}/columns`)
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            document.getElementById('columnsSection').style.display = 'block';
            document.getElementById('selectedFileName').textContent = data.filename;

            const dimensionsList = document.getElementById('dimensionsList');
            dimensionsList.innerHTML = '';
            data.dimensions.forEach(dim => {
                const item = createColumnItem(dim, 'dimension');
                dimensionsList.appendChild(item);
            });

            const measuresList = document.getElementById('measuresList');
            measuresList.innerHTML = '';
            data.measures.forEach(measure => {
                const item = createColumnItem(measure, 'measure');
                measuresList.appendChild(item);
            });

            if (data.dimensions.length === 0) {
                dimensionsList.innerHTML = '<p class="no-data">æš‚æ— ç»´åº¦å­—æ®µ</p>';
            }
            if (data.measures.length === 0) {
                measuresList.innerHTML = '<p class="no-data">æš‚æ— åº¦é‡å­—æ®µ</p>';
            }
        } else {
            alert('åŠ è½½å¤±è´¥: ' + data.message);
        }
    })
    .catch(error => {
        hideLoading();
        alert('åŠ è½½å¤±è´¥: ' + error.message);
    });
}

// åˆ›å»ºåˆ—é¡¹å…ƒç´ ï¼ˆå¯æ‹–æ‹½ï¼‰
function createColumnItem(columnName, type) {
    const item = document.createElement('div');
    item.className = 'column-item';
    item.draggable = true;
    item.dataset.columnName = columnName;
    item.dataset.columnType = type;

    const icon = type === 'dimension' ? 'ğŸ“' : 'ğŸ”¢';
    item.innerHTML = `
        <span class="column-icon">${icon}</span>
        <span class="column-name" title="${columnName}">${columnName}</span>
    `;

    // æ‹–æ‹½å¼€å§‹äº‹ä»¶
    item.addEventListener('dragstart', function(e) {
        e.dataTransfer.setData('columnName', columnName);
        e.dataTransfer.setData('columnType', type);
        item.classList.add('dragging');
    });

    // æ‹–æ‹½ç»“æŸäº‹ä»¶
    item.addEventListener('dragend', function(e) {
        item.classList.remove('dragging');
    });

    return item;
}

// å…è®¸æ”¾ç½®
function allowDrop(e) {
    e.preventDefault();
    e.currentTarget.classList.add('drag-over');
}

// æ‹–æ‹½æ”¾ç½®
function drop(e, zone) {
    e.preventDefault();
    e.currentTarget.classList.remove('drag-over');
    
    const columnName = e.dataTransfer.getData('columnName');
    const columnType = e.dataTransfer.getData('columnType');
    
    if (!columnName) return;
    
    // è¯äº‘å›¾é…ç½®
    if (zone === 'wordcloud_text') {
        wordcloudConfig.text_field = columnName;
        updateWordcloudDropZone('text');
        return;
    }
    
    if (zone === 'wordcloud_weight') {
        wordcloudConfig.weight_field = columnName;
        updateWordcloudDropZone('weight');
        return;
    }
    
    // è”åˆå›¾é…ç½®
    if (zone === 'combo_dimension') {
        comboConfig.dimension = columnName;
        updateComboDropZone('dimension');
        return;
    }
    
    if (zone === 'combo_measures') {
        // åº¦é‡å­—æ®µå¯ä»¥æ·»åŠ å¤šä¸ª
        const exists = comboConfig.measures.find(m => m.field === columnName);
        if (!exists) {
            comboConfig.measures.push({
                field: columnName,
                chart_type: 'bar',  // é»˜è®¤æŸ±çŠ¶å›¾
                aggregation: 'sum'  // é»˜è®¤æ±‚å’Œ
            });
            updateComboDropZone('measures');
        }
        return;
    }
    
    // å›¾è¡¨é…ç½®ï¼ˆåªå…è®¸å•ä¸ªå­—æ®µï¼‰
    if (zone === 'x_axis' || zone === 'y_axis' || zone === 'group_field') {
        chartConfig[zone] = columnName;
        updateChartDropZone(zone);
        return;
    }
    
    // è¡¨æ ¼é…ç½®ï¼ˆå…è®¸å¤šä¸ªå­—æ®µï¼‰
    if (dragConfig[zone] && dragConfig[zone].includes(columnName)) {
        return;
    }
    
    dragConfig[zone].push(columnName);
    updateDropZone(zone);
}

// æ›´æ–°æ”¾ç½®åŒºåŸŸæ˜¾ç¤º
function updateDropZone(zone) {
    const dropZone = document.getElementById(zone + 'DropZone');
    const hint = dropZone.querySelector('.drop-hint');
    
    if (dragConfig[zone].length === 0) {
        hint.style.display = 'block';
        return;
    }
    
    hint.style.display = 'none';
    
    // ç§»é™¤å·²æœ‰çš„å­—æ®µæ ‡ç­¾
    dropZone.querySelectorAll('.field-tag').forEach(tag => tag.remove());
    
    // æ·»åŠ æ–°çš„å­—æ®µæ ‡ç­¾
    dragConfig[zone].forEach(fieldName => {
        const tag = document.createElement('div');
        tag.className = 'field-tag';
        tag.innerHTML = `
            <span>${fieldName}</span>
            <button class="remove-field" onclick="removeField('${zone}', '${fieldName}')">&times;</button>
        `;
        dropZone.appendChild(tag);
    });
}

// ç§»é™¤å­—æ®µ
function removeField(zone, fieldName) {
    const index = dragConfig[zone].indexOf(fieldName);
    if (index > -1) {
        dragConfig[zone].splice(index, 1);
        updateDropZone(zone);
    }
}

// é‡ç½®æ‰€æœ‰é…ç½®
function resetAllConfig() {
    // é‡ç½®è¡¨æ ¼é…ç½®
    dragConfig = { rows: [], columns: [], values: [] };
    if (document.getElementById('rowsDropZone')) {
        updateDropZone('rows');
        updateDropZone('columns');
        updateDropZone('values');
    }
    
    // é‡ç½®å›¾è¡¨é…ç½®
    chartConfig = {
        x_axis: null,
        y_axis: null,
        group_field: null,
        x_axis_config: {
            aggregation: 'sum',
            sort: 'none',
            format: 'number',
            log_scale: false,
            axis_name: ''
        },
        y_axis_config: {
            aggregation: 'sum',
            sort: 'none',
            format: 'number',
            log_scale: false,
            axis_name: ''
        }
    };
    if (document.getElementById('xAxisDropZone')) {
        updateChartDropZone('x_axis');
        updateChartDropZone('y_axis');
        updateChartDropZone('group_field');
    }
    
    // é‡ç½®è”åˆå›¾é…ç½®
    comboConfig = {
        dimension: null,
        measures: []
    };
    if (document.getElementById('comboDimensionDropZone')) {
        updateComboDropZone('dimension');
        updateComboDropZone('measures');
    }
    
    // é‡ç½®è¯äº‘å›¾é…ç½®
    wordcloudConfig = {
        text_field: null,
        weight_field: null
    };
    if (document.getElementById('wordcloudTextDropZone')) {
        updateWordcloudDropZone('text');
        updateWordcloudDropZone('weight');
    }
    
    // æ¸…ç©ºæ˜¾ç¤ºåŒºåŸŸ
    document.getElementById('tableDisplayArea').innerHTML = `
        <div class="placeholder">
            <div class="placeholder-icon">ğŸ“Š</div>
            <p>é€‰æ‹©æ•°æ®æ–‡ä»¶å¹¶æ‹–æ‹½å­—æ®µå¼€å§‹åˆ›å»ºå¯è§†åŒ–</p>
        </div>
    `;
}

// å¤„ç†å¯è§†åŒ–ç±»å‹ä¸‹æ‹‰æ¡†å˜åŒ–
function handleVisualizationTypeChange(type) {
    currentVisualizationType = type;
    
    // æ›´æ–°é…ç½®åŒºåŸŸ
    updateConfigArea();
    
    // æ¸…ç©ºé…ç½®
    resetAllConfig();
}

// å¤„ç†ä¸»é¢˜å˜åŒ–
function handleThemeChange(theme) {
    currentTheme = theme;
    console.log('ä¸»é¢˜å·²åˆ‡æ¢åˆ°:', themeColors[theme].name);
    // ä¸»é¢˜ä¼šåœ¨ç”Ÿæˆå›¾è¡¨æ—¶åº”ç”¨ï¼Œæ— éœ€ç«‹å³æ›´æ–°
}

// é€‰æ‹©å¯è§†åŒ–ç±»å‹ï¼ˆä¿ç•™ä»¥å…¼å®¹æ—§ä»£ç ï¼‰
function selectVisualizationType(type) {
    currentVisualizationType = type;
    
    // å¦‚æœæœ‰ä¸‹æ‹‰æ¡†ï¼Œæ›´æ–°ä¸‹æ‹‰æ¡†çš„å€¼
    const select = document.getElementById('visualizationTypeSelect');
    if (select) {
        select.value = type;
    }
    
    // æ›´æ–°æŒ‰é’®çŠ¶æ€ï¼ˆå¦‚æœè¿˜æœ‰æŒ‰é’®çš„è¯ï¼‰
    document.querySelectorAll('.btn-table-type').forEach(btn => {
        btn.classList.remove('active');
    });
    const targetBtn = document.querySelector(`[data-type="${type}"]`);
    if (targetBtn) {
        targetBtn.classList.add('active');
    }
    
    // æ›´æ–°é…ç½®åŒºåŸŸ
    updateConfigArea();
    
    // æ¸…ç©ºé…ç½®
    resetAllConfig();
}

// æ›´æ–°é…ç½®åŒºåŸŸæ˜¾ç¤º
function updateConfigArea() {
    const tableArea = document.getElementById('dragConfigAreaTable');
    const chartArea = document.getElementById('dragConfigAreaChart');
    const comboArea = document.getElementById('dragConfigAreaCombo');
    const wordcloudArea = document.getElementById('dragConfigAreaWordcloud');
    
    if (currentVisualizationType === 'list' || currentVisualizationType === 'cross' || currentVisualizationType === 'sunburst') {
        // æ˜¾ç¤ºè¡¨æ ¼é…ç½®ï¼ˆæ¸…å•è¡¨ã€äº¤å‰è¡¨ã€æ—­æ—¥å›¾ï¼‰
        tableArea.style.display = 'grid';
        chartArea.style.display = 'none';
        comboArea.style.display = 'none';
        wordcloudArea.style.display = 'none';
    } else if (currentVisualizationType === 'combo_single' || currentVisualizationType === 'combo_dual') {
        // æ˜¾ç¤ºè”åˆå›¾é…ç½®
        tableArea.style.display = 'none';
        chartArea.style.display = 'none';
        comboArea.style.display = 'grid';
        wordcloudArea.style.display = 'none';
    } else if (currentVisualizationType === 'wordcloud') {
        // æ˜¾ç¤ºè¯äº‘å›¾é…ç½®
        tableArea.style.display = 'none';
        chartArea.style.display = 'none';
        comboArea.style.display = 'none';
        wordcloudArea.style.display = 'grid';
    } else if (currentVisualizationType === 'line' || currentVisualizationType === 'area' || currentVisualizationType === 'pie' || currentVisualizationType === 'bar' || currentVisualizationType === 'waterfall' || currentVisualizationType === 'map' || currentVisualizationType === 'scatter') {
        // æ˜¾ç¤ºå›¾è¡¨é…ç½®ï¼ˆæŠ˜çº¿å›¾ã€é¢ç§¯å›¾ã€é¥¼å›¾ã€æŸ±çŠ¶å›¾ã€ç€‘å¸ƒå›¾ã€åœ°å›¾ã€æ•£ç‚¹å›¾ï¼‰
        tableArea.style.display = 'none';
        chartArea.style.display = 'grid';
        comboArea.style.display = 'none';
        wordcloudArea.style.display = 'none';
        
        // è·å–æ ‡ç­¾å…ƒç´ 
        const xAxisLabel = document.getElementById('xAxisLabel');
        const yAxisLabel = document.getElementById('yAxisLabel');
        const xAxisHint = document.getElementById('xAxisHint');
        const yAxisHint = document.getElementById('yAxisHint');
        const groupFieldContainer = document.getElementById('groupFieldContainer');
        
        // æ›´æ–°æ ‡ç­¾æ–‡å­—
        if (currentVisualizationType === 'map') {
            xAxisLabel.textContent = 'åœ°åŒºå­—æ®µ';
            yAxisLabel.textContent = 'Yè½´ï¼ˆåº¦é‡ï¼‰';
            xAxisHint.textContent = 'å°†åœ°åŒºå­—æ®µæ‹–åˆ°æ­¤å¤„';
            yAxisHint.textContent = 'å°†åº¦é‡å­—æ®µæ‹–åˆ°æ­¤å¤„';
            groupFieldContainer.style.display = 'none';
        } else if (currentVisualizationType === 'scatter') {
            xAxisLabel.textContent = 'Xè½´ï¼ˆåº¦é‡ï¼‰';
            yAxisLabel.textContent = 'Yè½´ï¼ˆåº¦é‡ï¼‰';
            xAxisHint.textContent = 'å°†åº¦é‡å­—æ®µæ‹–åˆ°æ­¤å¤„';
            yAxisHint.textContent = 'å°†åº¦é‡å­—æ®µæ‹–åˆ°æ­¤å¤„';
            groupFieldContainer.style.display = 'block';
        } else {
            xAxisLabel.textContent = 'Xè½´ï¼ˆç»´åº¦ï¼‰';
            yAxisLabel.textContent = 'Yè½´ï¼ˆåº¦é‡ï¼‰';
            xAxisHint.textContent = 'å°†ç»´åº¦å­—æ®µæ‹–åˆ°æ­¤å¤„';
            yAxisHint.textContent = 'å°†åº¦é‡å­—æ®µæ‹–åˆ°æ­¤å¤„';
            groupFieldContainer.style.display = 'none';
        }
    }
}

// æ›´æ–°å›¾è¡¨æ”¾ç½®åŒºåŸŸæ˜¾ç¤º
function updateChartDropZone(zone) {
    let dropZone;
    if (zone === 'x_axis') {
        dropZone = document.getElementById('xAxisDropZone');
    } else if (zone === 'y_axis') {
        dropZone = document.getElementById('yAxisDropZone');
    } else if (zone === 'group_field') {
        dropZone = document.getElementById('groupFieldDropZone');
    }
    
    if (!dropZone) return;
    
    const hint = dropZone.querySelector('.drop-hint');
    
    if (!chartConfig[zone]) {
        hint.style.display = 'block';
        dropZone.querySelectorAll('.field-tag').forEach(tag => tag.remove());
        return;
    }
    
    hint.style.display = 'none';
    dropZone.querySelectorAll('.field-tag').forEach(tag => tag.remove());
    
    const tag = document.createElement('div');
    tag.className = 'field-tag';
    
    // ä¸ºx_axiså’Œy_axisæ·»åŠ é…ç½®æŒ‰é’®
    if (zone === 'x_axis' || zone === 'y_axis') {
        const config = chartConfig[zone + '_config'];
        const aggLabel = getAggregationLabel(config.aggregation);
        // æ˜¾ç¤ºæ ¼å¼ï¼šå­—æ®µå(èšåˆæ–¹å¼)
        const displayText = aggLabel ? `${chartConfig[zone]}(${aggLabel})` : chartConfig[zone];
        tag.innerHTML = `
            <span class="field-name">${displayText}</span>
            <button class="config-field" onclick="showAxisConfig('${zone}')" title="é…ç½®">âš™ï¸</button>
            <button class="remove-field" onclick="removeChartField('${zone}')">&times;</button>
        `;
    } else {
        tag.innerHTML = `
            <span>${chartConfig[zone]}</span>
            <button class="remove-field" onclick="removeChartField('${zone}')">&times;</button>
        `;
    }
    
    dropZone.appendChild(tag);
}

// è·å–èšåˆæ–¹å¼çš„æ˜¾ç¤ºæ ‡ç­¾
function getAggregationLabel(agg) {
    const labels = {
        'sum': 'æ±‚å’Œ',
        'avg': 'å¹³å‡å€¼',
        'count': 'è®¡æ•°',
        'max': 'æœ€å¤§å€¼',
        'min': 'æœ€å°å€¼',
        'none': ''
    };
    return labels[agg] || '';
}

// æ›´æ–°è”åˆå›¾æ”¾ç½®åŒºåŸŸæ˜¾ç¤º
function updateComboDropZone(zone) {
    if (zone === 'dimension') {
        const dropZone = document.getElementById('comboDimensionDropZone');
        const hint = dropZone.querySelector('.drop-hint');
        
        if (!comboConfig.dimension) {
            hint.style.display = 'block';
            dropZone.querySelectorAll('.field-tag').forEach(tag => tag.remove());
            return;
        }
        
        hint.style.display = 'none';
        dropZone.querySelectorAll('.field-tag').forEach(tag => tag.remove());
        
        const tag = document.createElement('div');
        tag.className = 'field-tag';
        tag.innerHTML = `
            <span>${comboConfig.dimension}</span>
            <button class="remove-field" onclick="removeComboField('dimension')">&times;</button>
        `;
        dropZone.appendChild(tag);
    } else if (zone === 'measures') {
        const dropZone = document.getElementById('comboMeasuresDropZone');
        const hint = dropZone.querySelector('.drop-hint');
        
        if (comboConfig.measures.length === 0) {
            hint.style.display = 'block';
            dropZone.querySelectorAll('.field-tag').forEach(tag => tag.remove());
            return;
        }
        
        hint.style.display = 'none';
        dropZone.querySelectorAll('.field-tag').forEach(tag => tag.remove());
        
        // æ·»åŠ æ¯ä¸ªåº¦é‡çš„æ ‡ç­¾
        comboConfig.measures.forEach((measure, index) => {
            const tag = document.createElement('div');
            tag.className = 'field-tag measure-tag';
            
            const chartTypeIcon = {
                'bar': 'ğŸ“Š',
                'line': 'ğŸ“ˆ',
                'area': 'ğŸ“Š'
            }[measure.chart_type] || 'ğŸ“Š';
            
            tag.innerHTML = `
                <span class="measure-field-name">${chartTypeIcon} ${measure.field}(${getAggregationLabel(measure.aggregation)})</span>
                <button class="config-field" onclick="showMeasureConfig(${index})" title="é…ç½®">âš™ï¸</button>
                <button class="remove-field" onclick="removeComboMeasure(${index})">&times;</button>
            `;
            dropZone.appendChild(tag);
        });
    }
}

// ç§»é™¤è”åˆå›¾å­—æ®µ
function removeComboField(zone) {
    if (zone === 'dimension') {
        comboConfig.dimension = null;
        updateComboDropZone('dimension');
    }
}

// ç§»é™¤è”åˆå›¾åº¦é‡
function removeComboMeasure(index) {
    comboConfig.measures.splice(index, 1);
    updateComboDropZone('measures');
}

// æ›´æ–°è¯äº‘å›¾æ‹–æ‹½åŒºåŸŸ
function updateWordcloudDropZone(zone) {
    if (zone === 'text') {
        const dropZone = document.getElementById('wordcloudTextDropZone');
        const hint = dropZone.querySelector('.drop-hint');
        
        if (!wordcloudConfig.text_field) {
            hint.style.display = 'block';
            dropZone.querySelectorAll('.field-tag').forEach(tag => tag.remove());
            return;
        }
        
        hint.style.display = 'none';
        dropZone.querySelectorAll('.field-tag').forEach(tag => tag.remove());
        
        const tag = document.createElement('div');
        tag.className = 'field-tag';
        tag.innerHTML = `
            <span>${wordcloudConfig.text_field}</span>
            <button class="remove-field" onclick="removeWordcloudField('text')">&times;</button>
        `;
        dropZone.appendChild(tag);
    } else if (zone === 'weight') {
        const dropZone = document.getElementById('wordcloudWeightDropZone');
        const hint = dropZone.querySelector('.drop-hint');
        
        if (!wordcloudConfig.weight_field) {
            hint.style.display = 'block';
            dropZone.querySelectorAll('.field-tag').forEach(tag => tag.remove());
            return;
        }
        
        hint.style.display = 'none';
        dropZone.querySelectorAll('.field-tag').forEach(tag => tag.remove());
        
        const tag = document.createElement('div');
        tag.className = 'field-tag';
        tag.innerHTML = `
            <span>${wordcloudConfig.weight_field}</span>
            <button class="remove-field" onclick="removeWordcloudField('weight')">&times;</button>
        `;
        dropZone.appendChild(tag);
    }
}

// ç§»é™¤è¯äº‘å›¾å­—æ®µ
function removeWordcloudField(zone) {
    if (zone === 'text') {
        wordcloudConfig.text_field = null;
        updateWordcloudDropZone('text');
    } else if (zone === 'weight') {
        wordcloudConfig.weight_field = null;
        updateWordcloudDropZone('weight');
    }
}

// å½“å‰æ­£åœ¨é…ç½®çš„åº¦é‡ç´¢å¼•
let currentConfigMeasureIndex = null;

// æ˜¾ç¤ºåº¦é‡é…ç½®é¢æ¿
function showMeasureConfig(index) {
    currentConfigMeasureIndex = index;
    const measure = comboConfig.measures[index];
    
    // è®¾ç½®æ ‡é¢˜
    document.getElementById('measureConfigTitle').textContent = `${measure.field} é…ç½®`;
    
    // å¡«å……å½“å‰é…ç½®
    document.getElementById('measureChartType').value = measure.chart_type;
    document.getElementById('measureAggregation').value = measure.aggregation;
    
    // æ˜¾ç¤ºå¼¹çª—
    document.getElementById('measureConfigModal').style.display = 'flex';
}

// å…³é—­åº¦é‡é…ç½®é¢æ¿
function closeMeasureConfig(event) {
    if (!event || event.target.id === 'measureConfigModal' || event.target.className === 'modal-close-btn' || event.target.closest('.btn-secondary')) {
        document.getElementById('measureConfigModal').style.display = 'none';
        currentConfigMeasureIndex = null;
    }
}

// ä¿å­˜åº¦é‡é…ç½®
function saveMeasureConfig() {
    if (currentConfigMeasureIndex === null) return;
    
    const measure = comboConfig.measures[currentConfigMeasureIndex];
    
    // è·å–é…ç½®å€¼
    measure.chart_type = document.getElementById('measureChartType').value;
    measure.aggregation = document.getElementById('measureAggregation').value;
    
    // æ›´æ–°æ˜¾ç¤º
    updateComboDropZone('measures');
    
    // å…³é—­å¼¹çª—
    document.getElementById('measureConfigModal').style.display = 'none';
    currentConfigMeasureIndex = null;
}

// å½“å‰æ­£åœ¨é…ç½®çš„è½´
let currentConfigAxis = null;

// æ˜¾ç¤ºè½´é…ç½®é¢æ¿
function showAxisConfig(axis) {
    currentConfigAxis = axis;
    const config = chartConfig[axis + '_config'];
    const axisLabel = axis === 'x_axis' ? 'Xè½´' : 'Yè½´';
    
    // è®¾ç½®æ ‡é¢˜
    document.getElementById('axisConfigTitle').textContent = `${axisLabel}è®¾ç½®`;
    
    // å¡«å……å½“å‰é…ç½®
    document.getElementById('axisAggregation').value = config.aggregation;
    document.getElementById('axisSort').value = config.sort;
    document.getElementById('axisFormat').value = config.format;
    document.getElementById('axisName').value = config.axis_name;
    
    // è®¾ç½®å¯¹æ•°è½´é€‰é¡¹
    const logScaleRadios = document.getElementsByName('logScale');
    logScaleRadios.forEach(radio => {
        radio.checked = radio.value === String(config.log_scale);
    });
    
    // æ˜¾ç¤ºå¼¹çª—
    document.getElementById('axisConfigModal').style.display = 'flex';
}

// å…³é—­è½´é…ç½®é¢æ¿
function closeAxisConfig(event) {
    if (!event || event.target.id === 'axisConfigModal' || event.target.className === 'modal-close-btn' || event.target.closest('.btn-secondary')) {
        document.getElementById('axisConfigModal').style.display = 'none';
        currentConfigAxis = null;
    }
}

// ä¿å­˜è½´é…ç½®
function saveAxisConfig() {
    if (!currentConfigAxis) return;
    
    const config = chartConfig[currentConfigAxis + '_config'];
    
    // è·å–é…ç½®å€¼
    config.aggregation = document.getElementById('axisAggregation').value;
    config.sort = document.getElementById('axisSort').value;
    config.format = document.getElementById('axisFormat').value;
    config.axis_name = document.getElementById('axisName').value.trim();
    
    // è·å–å¯¹æ•°è½´è®¾ç½®
    const logScaleRadios = document.getElementsByName('logScale');
    for (const radio of logScaleRadios) {
        if (radio.checked) {
            config.log_scale = radio.value === 'true';
            break;
        }
    }
    
    // æ›´æ–°æ˜¾ç¤º
    updateChartDropZone(currentConfigAxis);
    
    // å…³é—­å¼¹çª—
    document.getElementById('axisConfigModal').style.display = 'none';
    currentConfigAxis = null;
}

// ç§»é™¤å›¾è¡¨å­—æ®µ
function removeChartField(zone) {
    chartConfig[zone] = null;
    updateChartDropZone(zone);
}

// ç”Ÿæˆè¡¨æ ¼
function generateTable() {
    if (!selectedFileId) {
        alert(allTexts.please_select_data_file);
        return;
    }
    
    // æ—­æ—¥å›¾ä½¿ç”¨å›¾è¡¨ç”Ÿæˆæ¥å£
    if (currentVisualizationType === 'sunburst') {
        if (dragConfig.rows.length === 0) {
            alert('æ—­æ—¥å›¾éœ€è¦è‡³å°‘ä¸€ä¸ªç»´åº¦å­—æ®µï¼ˆè¡Œï¼‰');
            return;
        }
        if (dragConfig.values.length === 0) {
            alert('æ—­æ—¥å›¾éœ€è¦ä¸€ä¸ªåº¦é‡å­—æ®µï¼ˆå€¼ï¼‰');
            return;
        }
        
        showLoading(allTexts.generating_sunburst);
        
        fetch('/api/chart/generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                file_id: selectedFileId,
                chart_type: 'sunburst',
                rows: dragConfig.rows,
                values: dragConfig.values,
                theme: currentTheme
            })
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                currentChartFilename = data.filename;
                displayChart(data);
            } else {
                alert('ç”Ÿæˆå¤±è´¥: ' + data.message);
            }
        })
        .catch(error => {
            hideLoading();
            alert('ç”Ÿæˆå¤±è´¥: ' + error.message);
        });
        return;
    }
    
    // å…¶ä»–è¡¨æ ¼ç±»å‹
    showLoading(allTexts.generating_table);
    
    fetch('/api/table/generate', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            file_id: selectedFileId,
            table_type: currentVisualizationType,
            rows: dragConfig.rows,
            columns: dragConfig.columns,
            values: dragConfig.values
        })
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            displayTable(data);
        } else {
            alert('ç”Ÿæˆå¤±è´¥: ' + data.message);
        }
    })
    .catch(error => {
        hideLoading();
        alert('ç”Ÿæˆå¤±è´¥: ' + error.message);
    });
}

// åˆ‡æ¢æ–‡å­—é€‰é¡¹é¢æ¿
function toggleTextOptions() {
    const panel = document.getElementById('textOptionsPanel');
    if (panel.style.display === 'none') {
        panel.style.display = 'block';
    } else {
        panel.style.display = 'none';
    }
}

// åˆ‡æ¢æ–‡å­—è¾“å…¥æ¡†å¯ç”¨çŠ¶æ€
function toggleTextInput(type) {
    // ç‰¹æ®Šå¤„ç†IDçš„å¤§å°å†™
    let checkboxId, inputId;
    if (type === 'title') {
        checkboxId = 'enableTitle';
        inputId = 'titleInput';
    } else if (type === 'xlabel') {
        checkboxId = 'enableXLabel';
        inputId = 'xlabelInput';
    } else if (type === 'ylabel') {
        checkboxId = 'enableYLabel';
        inputId = 'ylabelInput';
    }
    
    const checkbox = document.getElementById(checkboxId);
    const input = document.getElementById(inputId);
    input.disabled = !checkbox.checked;
    if (!checkbox.checked) {
        input.value = '';
    }
}

// ç”Ÿæˆè¯äº‘å›¾
function generateWordcloud() {
    if (!selectedFileId) {
        alert(allTexts.please_select_data_file);
        return;
    }
    
    if (!wordcloudConfig.text_field) {
        alert(allTexts.select_text_field);
        return;
    }
    
    // è·å–é€‰æ‹©çš„å½¢çŠ¶
    const shape = document.getElementById('wordcloudShapeSelect').value;
    
    showLoading(allTexts.generating_wordcloud);
    
    fetch('/api/chart/wordcloud/generate', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            file_id: selectedFileId,
            text_field: wordcloudConfig.text_field,
            weight_field: wordcloudConfig.weight_field,
            shape: shape,
            theme: currentTheme
        })
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            currentChartFilename = data.filename;
            displayChart(data);
        } else {
            alert('ç”Ÿæˆå¤±è´¥: ' + data.message);
        }
    })
    .catch(error => {
        hideLoading();
        alert('ç”Ÿæˆå¤±è´¥: ' + error.message);
    });
}

function generateComboChart() {
    if (!selectedFileId) {
        alert(allTexts.please_select_data_file);
        return;
    }
    
    if (!comboConfig.dimension) {
        alert(allTexts.please_select_dimension_xaxis);
        return;
    }
    
    if (comboConfig.measures.length === 0) {
        alert('è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªåº¦é‡å­—æ®µ');
        return;
    }
    
    showLoading(allTexts.generating_combo);
    
    fetch('/api/chart/combo/generate', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            file_id: selectedFileId,
            chart_type: currentVisualizationType,  // combo_single æˆ– combo_dual
            dimension: comboConfig.dimension,
            measures: comboConfig.measures,
            theme: currentTheme
        })
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            currentChartFilename = data.filename;
            displayChart(data);
        } else {
            alert('ç”Ÿæˆå¤±è´¥: ' + data.message);
        }
    })
    .catch(error => {
        hideLoading();
        alert('ç”Ÿæˆå¤±è´¥: ' + error.message);
    });
}

// ç”Ÿæˆå›¾è¡¨
function generateChart() {
    if (!selectedFileId) {
        alert(allTexts.please_select_data_file);
        return;
    }
    
    if (!chartConfig.x_axis || !chartConfig.y_axis) {
        alert(allTexts.please_select_xy_axis);
        return;
    }
    
    // è·å–è‡ªå®šä¹‰æ–‡å­—
    const customTitle = document.getElementById('enableTitle').checked ? 
        document.getElementById('titleInput').value : '';
    const customXLabel = document.getElementById('enableXLabel').checked ? 
        document.getElementById('xlabelInput').value : '';
    const customYLabel = document.getElementById('enableYLabel').checked ? 
        document.getElementById('ylabelInput').value : '';
    
    showLoading(allTexts.generating_chart);
    
    fetch('/api/chart/generate', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            file_id: selectedFileId,
            chart_type: currentVisualizationType,
            x_axis: chartConfig.x_axis,
            y_axis: chartConfig.y_axis,
            group_field: chartConfig.group_field,  // æ•£ç‚¹å›¾åˆ†ç»„å­—æ®µ
            x_axis_config: chartConfig.x_axis_config,  // Xè½´é…ç½®
            y_axis_config: chartConfig.y_axis_config,  // Yè½´é…ç½®
            custom_title: customTitle,
            custom_xlabel: customXLabel,
            custom_ylabel: customYLabel,
            theme: currentTheme
        })
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            currentChartFilename = data.filename;
            displayChart(data);
        } else {
            alert('ç”Ÿæˆå¤±è´¥: ' + data.message);
        }
    })
    .catch(error => {
        hideLoading();
        alert('ç”Ÿæˆå¤±è´¥: ' + error.message);
    });
}

// æ˜¾ç¤ºè¡¨æ ¼
function displayTable(data) {
    const displayArea = document.getElementById('tableDisplayArea');
    
    let html = '<div class="table-container">';
    html += `<div class="table-header">
        <h3>${data.table_type === 'list' ? 'ğŸ“‹ æ¸…å•è¡¨' : 'ğŸ“Š äº¤å‰è¡¨'}</h3>
        <span class="table-info">å…± ${data.total_rows} è¡Œ${data.displayed_rows ? 'ï¼Œæ˜¾ç¤º ' + data.displayed_rows + ' è¡Œ' : ''}</span>
    </div>`;
    
    html += '<div class="table-wrapper"><table class="data-table">';
    
    // è¡¨å¤´
    html += '<thead><tr>';
    data.columns.forEach(col => {
        html += `<th>${col}</th>`;
    });
    html += '</tr></thead>';
    
    // è¡¨ä½“
    html += '<tbody>';
    data.data.forEach(row => {
        html += '<tr>';
        row.forEach(cell => {
            const displayValue = typeof cell === 'number' ? cell.toLocaleString() : cell;
            html += `<td>${displayValue}</td>`;
        });
        html += '</tr>';
    });
    html += '</tbody>';
    
    html += '</table></div></div>';
    
    displayArea.innerHTML = html;
}

// æ˜¾ç¤ºå›¾è¡¨
function displayChart(data) {
    const displayArea = document.getElementById('tableDisplayArea');
    
    const chartTypeNames = {
        'line': 'ğŸ“ˆ æŠ˜çº¿å›¾',
        'area': 'ğŸ“Š é¢ç§¯å›¾',
        'pie': 'ğŸ¥§ é¥¼å›¾',
        'bar': 'ğŸ“Š æŸ±çŠ¶å›¾',
        'waterfall': 'ğŸ“ˆ ç€‘å¸ƒå›¾',
        'scatter': 'ğŸ”µ æ•£ç‚¹å›¾',
        'combo_single': 'ğŸ“Š å•Yè”åˆå›¾',
        'combo_dual': 'ğŸ“Š åŒYè”åˆå›¾',
        'wordcloud': 'â˜ï¸ è¯äº‘å›¾',
        'sunburst': 'â˜€ï¸ æ—­æ—¥å›¾',
        'map': 'ğŸ—ºï¸ ä¸­å›½åœ°å›¾'
    };
    
    let html = '<div class="chart-container">';
    html += `<div class="chart-header">
        <h3>${chartTypeNames[data.chart_type] || 'å›¾è¡¨'}</h3>
        <button class="btn-download-chart" onclick="downloadChart()">
            ğŸ“¥ ä¸‹è½½${data.is_html ? 'HTML' : 'å›¾è¡¨'}
        </button>
    </div>`;
    
    if (data.is_html) {
        // æ˜¾ç¤ºHTMLå†…å®¹ï¼ˆåœ°å›¾ï¼‰- ä½¿ç”¨iframe
        html += `<div class="chart-display map-display">
            <iframe src="${data.chart_url}" frameborder="0" class="map-iframe"></iframe>
        </div>`;
    } else {
        // æ˜¾ç¤ºå›¾ç‰‡ï¼ˆæŸ±çŠ¶å›¾ã€ç€‘å¸ƒå›¾ï¼‰
        html += `<div class="chart-display">
            <img src="${data.image}" alt="${data.chart_type}" class="chart-image">
        </div>`;
    }
    
    html += '</div>';
    
    displayArea.innerHTML = html;
}

// ä¸‹è½½å›¾è¡¨
function downloadChart() {
    if (!currentChartFilename) {
        alert('æ²¡æœ‰å¯ä¸‹è½½çš„å›¾è¡¨');
        return;
    }
    
    window.location.href = `/api/chart/download/${currentChartFilename}`;
}

// åˆ é™¤æ–‡ä»¶
function deleteFile(fileId) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–‡ä»¶å—ï¼Ÿ')) {
        return;
    }

    showLoading('æ­£åœ¨åˆ é™¤...');

    fetch(`/api/file/${fileId}/delete`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            location.reload();
        } else {
            alert('åˆ é™¤å¤±è´¥: ' + data.message);
        }
    })
    .catch(error => {
        hideLoading();
        alert('åˆ é™¤å¤±è´¥: ' + error.message);
    });
}

// æŠ˜å /å±•å¼€åˆ†ç»„
function toggleGroup(groupId) {
    const list = document.getElementById(groupId + 'List');
    const icon = event.target;
    
    if (list.style.display === 'none') {
        list.style.display = 'block';
        icon.textContent = 'â–¼';
    } else {
        list.style.display = 'none';
        icon.textContent = 'â–¶';
    }
}

// æ˜¾ç¤ºåŠ è½½æç¤º
function showLoading(message) {
    const loading = document.createElement('div');
    loading.id = 'loadingOverlay';
    loading.className = 'loading-overlay';
    loading.innerHTML = `
        <div class="loading-content">
            <div class="spinner"></div>
            <p>${message}</p>
        </div>
    `;
    document.body.appendChild(loading);
}

// éšè—åŠ è½½æç¤º
function hideLoading() {
    const loading = document.getElementById('loadingOverlay');
    if (loading) {
        loading.remove();
    }
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    // å¦‚æœæœ‰æ–‡ä»¶ï¼Œè‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªæ–‡ä»¶
    const selector = document.getElementById('fileSelector');
    if (selector && selector.options.length > 1) {
        // è·³è¿‡ç¬¬ä¸€ä¸ª"è¯·é€‰æ‹©æ–‡ä»¶"é€‰é¡¹ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ªå®é™…æ–‡ä»¶
        const firstFileId = selector.options[1].value;
        if (firstFileId) {
            selector.value = firstFileId;
            // æ³¨æ„ï¼šä¸è‡ªåŠ¨è°ƒç”¨selectFileï¼Œè®©ç”¨æˆ·æ‰‹åŠ¨é€‰æ‹©æˆ–æ‹–æ‹½
            // å¦‚æœéœ€è¦è‡ªåŠ¨åŠ è½½ï¼Œå–æ¶ˆä¸‹é¢è¿™è¡Œçš„æ³¨é‡Šï¼š
            // selectFile(parseInt(firstFileId));
        }
    }
});
</script>
{% endblock %}
