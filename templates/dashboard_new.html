{% extends "base.html" %}

{% block title %}ä»ªè¡¨ç›˜ - æ•°æ®å¯è§†åŒ–ç¨‹åº{% endblock %}

{% block content %}
<div class="dashboard-new-container">
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <header class="top-header">
        <div class="header-left">
            <h1 class="app-title">{{ texts.app_title }} - {{ texts.dashboard_mode }}</h1>
        </div>
        <div class="header-right">
            <a href="{{ url_for('dashboard') }}" class="btn btn-classic-mode" title="{{ texts.switch_to_classic }}">
                ğŸ“‹ {{ texts.classic_mode }}
            </a>
            <!-- è¯­è¨€åˆ‡æ¢æŒ‰é’® -->
            <div class="language-switcher">
                <button onclick="switchLanguage('zh')" class="btn btn-lang {% if lang == 'zh' %}active{% endif %}" id="lang-btn-zh" title="ä¸­æ–‡">
                    ğŸ‡¨ğŸ‡³ ä¸­æ–‡
                </button>
                <button onclick="switchLanguage('en')" class="btn btn-lang {% if lang == 'en' %}active{% endif %}" id="lang-btn-en" title="English">
                    ğŸ‡ºğŸ‡¸ EN
                </button>
            </div>
            <span class="welcome-text">{{ texts.welcome }}ï¼Œ{{ username }}</span>
            <a href="{{ url_for('logout') }}" class="btn btn-logout">{{ texts.logout }}</a>
        </div>
    </header>

    <div class="main-layout">
        <!-- å·¦ä¾§è¾¹æ  -->
        <aside class="left-sidebar">
            <!-- æ•°æ®åŒºåŸŸ -->
            <div class="sidebar-panel">
                <div class="panel-header">
                    <span class="icon">ğŸ“Š</span>
                    <h3 id="dataTitle">{{ texts.data }}</h3>
                </div>
                
                <!-- æ–‡ä»¶ä¸Šä¼  -->
                <div class="upload-section">
                    <button class="btn-upload" id="uploadBtn" onclick="document.getElementById('fileInput').click()">
                        ğŸ“ {{ texts.upload_file }}
                    </button>
                    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" style="display: none;" onchange="uploadFile(this)">
                </div>

                <!-- æ–‡ä»¶åˆ—è¡¨ -->
                <div class="file-list-section">
                    <div class="file-list-header" id="fileListHeader">{{ texts.select_file }}</div>
                    <div class="file-list" id="fileList">
                        {% if data_files %}
                            {% for file in data_files %}
                            <div class="file-list-item" data-file-id="{{ file.id }}">
                                <span class="file-name">{{ file.original_filename }}</span>
                                <button class="file-delete-btn" title="{{ texts.delete_file }}">ğŸ—‘ï¸</button>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="file-list-empty" id="fileListEmpty">{{ texts.no_data_files }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- å­—æ®µåŒºåŸŸ -->
            <div class="sidebar-panel" id="fieldsPanel" style="display: none;">
                <div class="panel-header">
                    <span class="icon">ğŸ“</span>
                    <h3 id="fieldsTitle">{{ texts.fields }}</h3>
                </div>

                <!-- ç»´åº¦ -->
                <div class="field-group">
                    <div class="field-group-header" onclick="toggleFieldGroup('dimensions')">
                        <span class="collapse-icon">â–¼</span>
                        <span id="dimensionsTitle">{{ texts.dimensions }}</span>
                    </div>
                    <div class="field-list" id="dimensionsList">
                        <!-- åŠ¨æ€å¡«å…… -->
                    </div>
                </div>

                <!-- åº¦é‡ -->
                <div class="field-group">
                    <div class="field-group-header" onclick="toggleFieldGroup('measures')">
                        <span class="collapse-icon">â–¼</span>
                        <span id="measuresTitle">{{ texts.measures }}</span>
                    </div>
                    <div class="field-list" id="measuresList">
                        <!-- åŠ¨æ€å¡«å…… -->
                    </div>
                </div>
            </div>

            <!-- éƒ¨ä»¶é…ç½®é¢æ¿ -->
            <div class="sidebar-panel" id="widgetConfigPanel" style="display: none;">
                <div class="panel-header">
                    <span class="icon">âš™ï¸</span>
                    <h3 id="widgetConfigTitle">{{ texts.widget_config }}</h3>
                    <button class="close-config-btn" onclick="closeLeftConfig()" title="{{ texts.close }}">&times;</button>
                </div>

                <div class="config-content" id="widgetConfigContent">
                    <!-- åŠ¨æ€å¡«å……é…ç½®å†…å®¹ -->
                </div>
            </div>
        </aside>

        <!-- ä¸­é—´å†…å®¹åŒºåŸŸ -->
        <div class="center-content">
            <!-- éƒ¨ä»¶å·¥å…·æ  -->
            <div class="widget-toolbar">
                <div class="toolbar-label" id="widgetLabel">{{ texts.widgets }}ï¼š</div>
                <div class="widget-items">
                    <div class="widget-item" draggable="true" ondragstart="dragWidget(event, 'list')" title="{{ texts.list_table }}">
                        <span class="widget-icon">ğŸ“‹</span>
                        <span class="widget-label" data-widget-type="list">{{ texts.list_table }}</span>
                    </div>
                    <div class="widget-item" draggable="true" ondragstart="dragWidget(event, 'cross')" title="{{ texts.cross_table }}">
                        <span class="widget-icon">ğŸ“Š</span>
                        <span class="widget-label" data-widget-type="cross">{{ texts.cross_table }}</span>
                    </div>
                    <div class="widget-item" draggable="true" ondragstart="dragWidget(event, 'chart')" title="{{ texts.widget_chart }}">
                        <span class="widget-icon">ğŸ“ˆ</span>
                        <span class="widget-label" data-widget-type="chart">{{ texts.widget_chart }}</span>
                    </div>
                    <div class="widget-item" draggable="true" ondragstart="dragWidget(event, 'text')" title="{{ texts.widget_text }}">
                        <span class="widget-icon">ğŸ“</span>
                        <span class="widget-label" data-widget-type="text">{{ texts.widget_text }}</span>
                    </div>
                    <div class="widget-item" draggable="true" ondragstart="dragWidget(event, 'image')" title="{{ texts.widget_image }}">
                        <span class="widget-icon">ğŸ–¼ï¸</span>
                        <span class="widget-label" data-widget-type="image">{{ texts.widget_image }}</span>
                    </div>
                </div>
            </div>

            <!-- ä»ªè¡¨ç›˜ç”»å¸ƒåŒºåŸŸ -->
            <div class="dashboard-canvas" id="dashboardCanvas" 
                 ondrop="dropWidget(event)" 
                 ondragover="allowDrop(event)">
                <div class="canvas-placeholder">
                    <div class="placeholder-icon">ğŸ“Š</div>
                    <p id="canvasPlaceholder">{{ texts.drag_widget_here }}</p>
                    <p class="placeholder-hint" id="canvasHint">{{ texts.supports_widgets }}</p>
                    <div class="usage-tips">
                        <p><strong id="tipsTitle">ğŸ’¡ {{ texts.usage_tips }}ï¼š</strong></p>
                        <p id="tip1">â€¢ {{ texts.tip_click_widget }}</p>
                        <p id="tip2">â€¢ {{ texts.tip_drag_resize }}</p>
                        <p id="tip3">â€¢ {{ texts.tip_resize_widget }}</p>
                        <p id="tip4">â€¢ {{ texts.tip_hover_delete }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- å›¾å½¢é…ç½®é¢æ¿ï¼ˆæ¨¡æ€æ¡†ï¼‰ -->
<div class="modal-overlay" id="chartConfigModal" style="display: none;" onclick="closeChartConfig(event)">
    <div class="modal-content chart-config-panel" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h2>å›¾å½¢é…ç½®</h2>
            <button class="modal-close-btn" onclick="closeChartConfig()">&times;</button>
        </div>
        <div class="modal-body">
            <!-- å›¾è¡¨ç±»å‹é€‰æ‹© -->
            <div class="config-section">
                <label class="config-label">å›¾è¡¨ç±»å‹</label>
                <select id="chartTypeSelect" class="config-select" onchange="updateChartConfig()">
                    <option value="">-- é€‰æ‹©å›¾è¡¨ç±»å‹ --</option>
                    <option value="line">ğŸ“ˆ æŠ˜çº¿å›¾</option>
                    <option value="bar">ğŸ“Š æŸ±çŠ¶å›¾</option>
                    <option value="area">ğŸ“Š é¢ç§¯å›¾</option>
                    <option value="pie">ğŸ¥§ é¥¼å›¾</option>
                    <option value="waterfall">ğŸ“ˆ ç€‘å¸ƒå›¾</option>
                    <option value="scatter">ğŸ”µ æ•£ç‚¹å›¾</option>
                    <option value="wordcloud">â˜ï¸ è¯äº‘å›¾</option>
                    <option value="map">ğŸ—ºï¸ åœ°å›¾</option>
                    <option value="sunburst">â˜€ï¸ æ—­æ—¥å›¾</option>
                    <option value="combo_single">ğŸ“Š å•Yè”åˆå›¾</option>
                    <option value="combo_dual">ğŸ“Š åŒYè”åˆå›¾</option>
                </select>
            </div>

            <!-- ä¸»é¢˜é€‰æ‹© -->
            <div class="config-section">
                <label class="config-label">ä¸»é¢˜</label>
                <select id="chartThemeSelect" class="config-select">
                    <option value="purple">ç´«è‰²</option>
                    <option value="blue">è“è‰²</option>
                    <option value="green">ç»¿è‰²</option>
                    <option value="red">çº¢è‰²</option>
                    <option value="orange">æ©™è‰²</option>
                    <option value="pink">ç²‰è‰²</option>
                    <option value="teal">é’è‰²</option>
                </select>
            </div>

            <!-- åŠ¨æ€é…ç½®åŒºåŸŸ -->
            <div id="dynamicConfigArea">
                <!-- æ ¹æ®å›¾è¡¨ç±»å‹åŠ¨æ€æ˜¾ç¤ºé…ç½®é¡¹ -->
            </div>

            <!-- æŒ‰é’® -->
            <div class="config-buttons">
                <button class="btn btn-secondary" onclick="closeChartConfig()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="generateChart()">ç”Ÿæˆå›¾è¡¨</button>
            </div>
        </div>
    </div>
</div>

<!-- æ–‡æœ¬ç¼–è¾‘é¢æ¿ -->
<div class="modal-overlay" id="textEditModal" style="display: none;" onclick="closeTextEdit(event)">
    <div class="modal-content text-edit-panel" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h2>ç¼–è¾‘æ–‡æœ¬</h2>
            <button class="modal-close-btn" onclick="closeTextEdit()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="config-section">
                <label class="config-label">æ–‡æœ¬å†…å®¹</label>
                <textarea id="textContentInput" class="text-input" rows="10" placeholder="è¾“å…¥æ–‡æœ¬å†…å®¹..."></textarea>
            </div>

            <div class="config-section">
                <label class="config-label">å­—ä½“å¤§å°</label>
                <select id="textFontSizeSelect" class="config-select">
                    <option value="12">12px</option>
                    <option value="14">14px</option>
                    <option value="16" selected>16px</option>
                    <option value="18">18px</option>
                    <option value="20">20px</option>
                    <option value="24">24px</option>
                    <option value="28">28px</option>
                    <option value="32">32px</option>
                </select>
            </div>

            <div class="config-buttons">
                <button class="btn btn-secondary" onclick="closeTextEdit()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveTextContent()">ç¡®å®š</button>
            </div>
        </div>
    </div>
</div>

<!-- å›¾ç‰‡ä¸Šä¼ é¢æ¿ -->
<div class="modal-overlay" id="imageUploadModal" style="display: none;" onclick="closeImageUpload(event)">
    <div class="modal-content image-upload-panel" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h2>ä¸Šä¼ å›¾ç‰‡</h2>
            <button class="modal-close-btn" onclick="closeImageUpload()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="config-section">
                <label class="config-label">é€‰æ‹©å›¾ç‰‡</label>
                <input type="file" id="imageFileInput" accept="image/*" class="file-input">
            </div>

            <div class="config-buttons">
                <button class="btn btn-secondary" onclick="closeImageUpload()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="uploadImage()">ä¸Šä¼ </button>
            </div>
        </div>
    </div>
</div>

<script>
// å…¨å±€å˜é‡
let selectedFileId = null;
let currentColumns = [];
let widgetCounter = 0;
let currentEditingWidget = null;

// éƒ¨ä»¶é…ç½®å­˜å‚¨
let widgetConfigs = {};

// å½“å‰è¯­è¨€
var currentLanguage = '{{ lang }}';
var allTexts = {{ texts | tojson }};

// åˆ‡æ¢è¯­è¨€ï¼ˆæ— åˆ·æ–°ï¼‰
function switchLanguage(lang) {
    if (lang === currentLanguage) return;
    
    fetch('/api/set_language/' + lang, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentLanguage = lang;
            allTexts = data.texts;
            updatePageTexts();
            updateLanguageButtons();
        }
    })
    .catch(error => {
        console.error('è¯­è¨€åˆ‡æ¢å¤±è´¥:', error);
    });
}

// æ›´æ–°è¯­è¨€æŒ‰é’®çŠ¶æ€
function updateLanguageButtons() {
    document.getElementById('lang-btn-zh').classList.toggle('active', currentLanguage === 'zh');
    document.getElementById('lang-btn-en').classList.toggle('active', currentLanguage === 'en');
}

// æ›´æ–°é¡µé¢æ–‡æœ¬
function updatePageTexts() {
    // æ›´æ–°headeræ ‡é¢˜
    document.querySelector('.app-title').textContent = allTexts.app_title + ' - ' + allTexts.dashboard_mode;
    
    // æ›´æ–°æŒ‰é’®æ–‡æœ¬
    const classicBtn = document.querySelector('.btn-classic-mode');
    if (classicBtn) {
        classicBtn.innerHTML = 'ğŸ“‹ ' + allTexts.classic_mode;
        classicBtn.title = allTexts.switch_to_classic;
    }
    
    // æ›´æ–°æ¬¢è¿æ–‡æœ¬
    const welcomeText = document.querySelector('.welcome-text');
    if (welcomeText) {
        const username = welcomeText.textContent.split('ï¼Œ')[1] || welcomeText.textContent.split(', ')[1];
        welcomeText.textContent = allTexts.welcome + (currentLanguage === 'zh' ? 'ï¼Œ' : ', ') + username;
    }
    
    // æ›´æ–°æ³¨é”€æŒ‰é’®
    document.querySelector('.btn-logout').textContent = allTexts.logout;
    
    // æ›´æ–°ä¾§è¾¹æ æ ‡é¢˜
    const dataTitle = document.getElementById('dataTitle');
    if (dataTitle) dataTitle.textContent = allTexts.data;
    
    const fieldsTitle = document.getElementById('fieldsTitle');
    if (fieldsTitle) fieldsTitle.textContent = allTexts.fields;
    
    const widgetConfigTitle = document.getElementById('widgetConfigTitle');
    if (widgetConfigTitle) widgetConfigTitle.textContent = allTexts.widget_config;
    
    // æ›´æ–°ä¸Šä¼ æŒ‰é’®
    const uploadBtn = document.getElementById('uploadBtn');
    if (uploadBtn) uploadBtn.innerHTML = 'ğŸ“ ' + allTexts.upload_file;
    
    // æ›´æ–°æ–‡ä»¶åˆ—è¡¨æ ‡é¢˜
    const fileListHeader = document.getElementById('fileListHeader');
    if (fileListHeader) fileListHeader.textContent = allTexts.select_file;
    
    const fileListEmpty = document.getElementById('fileListEmpty');
    if (fileListEmpty) fileListEmpty.textContent = allTexts.no_data_files;
    
    // æ›´æ–°ç»´åº¦/åº¦é‡æ ‡é¢˜
    const dimensionsTitle = document.getElementById('dimensionsTitle');
    if (dimensionsTitle) dimensionsTitle.textContent = allTexts.dimensions;
    
    const measuresTitle = document.getElementById('measuresTitle');
    if (measuresTitle) measuresTitle.textContent = allTexts.measures;
    
    // æ›´æ–°éƒ¨ä»¶å·¥å…·æ æ ‡ç­¾
    const widgetLabel = document.getElementById('widgetLabel');
    if (widgetLabel) widgetLabel.textContent = allTexts.widgets + 'ï¼š';
    
    // æ›´æ–°éƒ¨ä»¶ç±»å‹æ ‡ç­¾
    document.querySelectorAll('[data-widget-type]').forEach(el => {
        const type = el.getAttribute('data-widget-type');
        if (type === 'list') el.textContent = allTexts.list_table;
        else if (type === 'cross') el.textContent = allTexts.cross_table;
        else if (type === 'chart') el.textContent = allTexts.widget_chart;
        else if (type === 'text') el.textContent = allTexts.widget_text;
        else if (type === 'image') el.textContent = allTexts.widget_image;
    });
    
    // æ›´æ–°ç”»å¸ƒæç¤ºæ–‡æœ¬
    const canvasPlaceholder = document.getElementById('canvasPlaceholder');
    if (canvasPlaceholder) canvasPlaceholder.textContent = allTexts.drag_widget_here;
    
    const canvasHint = document.getElementById('canvasHint');
    if (canvasHint) canvasHint.textContent = allTexts.supports_widgets;
    
    const tipsTitle = document.getElementById('tipsTitle');
    if (tipsTitle) tipsTitle.innerHTML = 'ğŸ’¡ ' + allTexts.usage_tips + 'ï¼š';
    
    const tip1 = document.getElementById('tip1');
    if (tip1) tip1.textContent = 'â€¢ ' + allTexts.tip_click_widget;
    
    const tip2 = document.getElementById('tip2');
    if (tip2) tip2.textContent = 'â€¢ ' + allTexts.tip_drag_resize;
    
    const tip3 = document.getElementById('tip3');
    if (tip3) tip3.textContent = 'â€¢ ' + allTexts.tip_resize_widget;
    
    const tip4 = document.getElementById('tip4');
    if (tip4) tip4.textContent = 'â€¢ ' + allTexts.tip_hover_delete;
    
    // æ›´æ–°æ‰€æœ‰å·²å­˜åœ¨çš„éƒ¨ä»¶å ä½ç¬¦æ–‡æœ¬
    document.querySelectorAll('.widget-placeholder').forEach(placeholder => {
        const widget = placeholder.closest('.widget');
        if (widget) {
            const widgetType = widget.getAttribute('data-widget-type');
            if (widgetType === 'list' || widgetType === 'cross') {
                placeholder.textContent = allTexts.click_widget_to_config;
            } else if (widgetType === 'chart') {
                placeholder.textContent = allTexts.click_widget_config_chart;
            } else if (widgetType === 'text') {
                placeholder.textContent = allTexts.click_widget_add_text;
            } else if (widgetType === 'image') {
                placeholder.textContent = allTexts.click_widget_upload_image;
            }
        }
    });
}

// ä¸Šä¼ æ–‡ä»¶
function uploadFile(input) {
    const file = input.files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append('file', file);

    showLoading('æ­£åœ¨ä¸Šä¼ æ–‡ä»¶...');

    fetch('/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            alert('æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼');
            // ä¸å†åˆ·æ–°é¡µé¢ï¼Œè€Œæ˜¯åŠ¨æ€æ·»åŠ æ–‡ä»¶åˆ°ä¸‹æ‹‰åˆ—è¡¨
            addFileToSelector(data.file_id, data.filename);
            // è‡ªåŠ¨é€‰æ‹©æ–°ä¸Šä¼ çš„æ–‡ä»¶
            selectFile(data.file_id);
        } else {
            alert('ä¸Šä¼ å¤±è´¥: ' + data.message);
        }
        // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©å™¨ï¼Œå…è®¸é‡æ–°ä¸Šä¼ åŒä¸€æ–‡ä»¶
        input.value = '';
    })
    .catch(error => {
        hideLoading();
        alert('ä¸Šä¼ å¤±è´¥: ' + error.message);
        input.value = '';
    });
}

// æ·»åŠ æ–‡ä»¶åˆ°åˆ—è¡¨
function addFileToSelector(fileId, filename) {
    const fileList = document.getElementById('fileList');
    
    // ç§»é™¤"æš‚æ— æ•°æ®æ–‡ä»¶"æç¤º
    const emptyMsg = fileList.querySelector('.file-list-empty');
    if (emptyMsg) {
        emptyMsg.remove();
    }
    
    // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨
    const existingItem = fileList.querySelector(`[data-file-id="${fileId}"]`);
    if (existingItem) {
        return; // æ–‡ä»¶å·²å­˜åœ¨ï¼Œä¸é‡å¤æ·»åŠ 
    }
    
    // åˆ›å»ºæ–°æ–‡ä»¶é¡¹
    const fileItem = document.createElement('div');
    fileItem.className = 'file-list-item';
    fileItem.dataset.fileId = fileId;
    
    const fileName = document.createElement('span');
    fileName.className = 'file-name';
    fileName.textContent = filename;
    
    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'file-delete-btn';
    deleteBtn.textContent = 'ğŸ—‘ï¸';
    deleteBtn.title = 'åˆ é™¤æ–‡ä»¶';
    
    // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
    fileItem.addEventListener('click', function(e) {
        if (e.target.classList.contains('file-delete-btn')) {
            return;
        }
        selectFile(fileId);
    });
    
    deleteBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        deleteFile(fileId, e);
    });
    
    fileItem.appendChild(fileName);
    fileItem.appendChild(deleteBtn);
    fileList.appendChild(fileItem);
}

// é€‰æ‹©æ–‡ä»¶
function selectFile(fileId) {
    if (!fileId) {
        document.getElementById('fieldsPanel').style.display = 'none';
        return;
    }

    selectedFileId = fileId;
    
    // æ›´æ–°é€‰ä¸­çŠ¶æ€
    const fileList = document.getElementById('fileList');
    const allItems = fileList.querySelectorAll('.file-list-item');
    allItems.forEach(item => {
        if (item.dataset.fileId == fileId) {
            item.classList.add('selected');
        } else {
            item.classList.remove('selected');
        }
    });
    
    loadFileColumns(fileId);
}

// ä¿æŒå…¼å®¹æ€§
function handleFileSelect(fileId) {
    selectFile(fileId);
}

// åˆ é™¤æ–‡ä»¶
function deleteFile(fileId, event) {
    // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¦å‘æ–‡ä»¶é€‰æ‹©
    if (event) {
        event.stopPropagation();
    }
    
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–‡ä»¶å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ã€‚')) {
        return;
    }
    
    showLoading('æ­£åœ¨åˆ é™¤æ–‡ä»¶...');
    
    fetch(`/api/file/${fileId}/delete`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            alert('æ–‡ä»¶åˆ é™¤æˆåŠŸï¼');
            // ä»åˆ—è¡¨ä¸­ç§»é™¤
            const fileItem = document.querySelector(`[data-file-id="${fileId}"]`);
            if (fileItem) {
                fileItem.remove();
            }
            
            // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰é€‰ä¸­çš„æ–‡ä»¶ï¼Œæ¸…ç©ºå­—æ®µé¢æ¿
            if (selectedFileId == fileId) {
                selectedFileId = null;
                document.getElementById('fieldsPanel').style.display = 'none';
                document.getElementById('dimensionsList').innerHTML = '';
                document.getElementById('measuresList').innerHTML = '';
            }
            
            // å¦‚æœåˆ—è¡¨ä¸ºç©ºï¼Œæ˜¾ç¤ºæç¤º
            const fileList = document.getElementById('fileList');
            if (fileList.children.length === 0) {
                fileList.innerHTML = '<div class="file-list-empty">æš‚æ— æ•°æ®æ–‡ä»¶</div>';
            }
        } else {
            alert('åˆ é™¤å¤±è´¥: ' + data.message);
        }
    })
    .catch(error => {
        hideLoading();
        alert('åˆ é™¤å¤±è´¥: ' + error.message);
    });
}

// åŠ è½½æ–‡ä»¶å­—æ®µ
function loadFileColumns(fileId) {
    fetch(`/api/file/${fileId}/columns`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // ä¿å­˜å­—æ®µä¿¡æ¯ï¼ˆç”¨äºåç»­ä½¿ç”¨ï¼‰
            currentColumns = {
                dimensions: data.dimensions || [],
                measures: data.measures || []
            };
            displayColumns(data);
            document.getElementById('fieldsPanel').style.display = 'block';
        }
    })
    .catch(error => {
        console.error('åŠ è½½å­—æ®µå¤±è´¥:', error);
        alert('åŠ è½½å­—æ®µå¤±è´¥: ' + error.message);
    });
}

// æ˜¾ç¤ºå­—æ®µåˆ—è¡¨
function displayColumns(data) {
    const dimensionsList = document.getElementById('dimensionsList');
    const measuresList = document.getElementById('measuresList');
    
    dimensionsList.innerHTML = '';
    measuresList.innerHTML = '';

    // æ˜¾ç¤ºç»´åº¦å­—æ®µ
    if (data.dimensions && data.dimensions.length > 0) {
        data.dimensions.forEach(fieldName => {
            const fieldItem = document.createElement('div');
            fieldItem.className = 'field-item';
            fieldItem.draggable = true;
            fieldItem.textContent = fieldName;
            fieldItem.dataset.columnName = fieldName;
            fieldItem.dataset.columnType = 'dimension';
            
            fieldItem.addEventListener('dragstart', function(e) {
                e.dataTransfer.setData('columnName', fieldName);
                e.dataTransfer.setData('columnType', 'dimension');
            });
            
            dimensionsList.appendChild(fieldItem);
        });
    } else {
        dimensionsList.innerHTML = '<div style="padding: 10px; color: #999; font-size: 12px;">æš‚æ— ç»´åº¦å­—æ®µ</div>';
    }

    // æ˜¾ç¤ºåº¦é‡å­—æ®µ
    if (data.measures && data.measures.length > 0) {
        data.measures.forEach(fieldName => {
            const fieldItem = document.createElement('div');
            fieldItem.className = 'field-item';
            fieldItem.draggable = true;
            fieldItem.textContent = fieldName;
            fieldItem.dataset.columnName = fieldName;
            fieldItem.dataset.columnType = 'measure';
            
            fieldItem.addEventListener('dragstart', function(e) {
                e.dataTransfer.setData('columnName', fieldName);
                e.dataTransfer.setData('columnType', 'measure');
            });
            
            measuresList.appendChild(fieldItem);
        });
    } else {
        measuresList.innerHTML = '<div style="padding: 10px; color: #999; font-size: 12px;">æš‚æ— åº¦é‡å­—æ®µ</div>';
    }
}

// æ‹–æ‹½éƒ¨ä»¶
function dragWidget(event, widgetType) {
    event.dataTransfer.setData('widgetType', widgetType);
}

// å…è®¸æ”¾ç½®
function allowDrop(event) {
    event.preventDefault();
}

// æ”¾ç½®éƒ¨ä»¶
function dropWidget(event) {
    event.preventDefault();
    
    const widgetType = event.dataTransfer.getData('widgetType');
    if (!widgetType) return;

    // ç§»é™¤å ä½ç¬¦
    const placeholder = document.querySelector('.canvas-placeholder');
    if (placeholder) {
        placeholder.remove();
    }

    // åˆ›å»ºéƒ¨ä»¶
    createWidget(widgetType, event.clientX, event.clientY);
}

// åˆ›å»ºéƒ¨ä»¶
function createWidget(type, x, y) {
    widgetCounter++;
    const widgetId = `widget_${widgetCounter}`;
    
    const canvas = document.getElementById('dashboardCanvas');
    const canvasRect = canvas.getBoundingClientRect();
    
    const widget = document.createElement('div');
    widget.className = 'dashboard-widget';
    widget.id = widgetId;
    widget.style.left = (x - canvasRect.left) + 'px';
    widget.style.top = (y - canvasRect.top) + 'px';
    
    // éƒ¨ä»¶å·¥å…·æ ï¼ˆhoveræ—¶æ˜¾ç¤ºï¼‰
    const toolbar = document.createElement('div');
    toolbar.className = 'widget-toolbar-hover';
    toolbar.innerHTML = `
        <button class="widget-tool-btn" onclick="event.stopPropagation(); deleteWidget('${widgetId}')" title="åˆ é™¤">
            <span>ğŸ—‘ï¸</span>
        </button>
    `;
    
    // éƒ¨ä»¶ç±»å‹æ ‡ç­¾ï¼ˆå·¦ä¸Šè§’ï¼‰
    const typeLabel = document.createElement('div');
    typeLabel.className = 'widget-type-label';
    typeLabel.textContent = getWidgetTypeIcon(type);
    
    // éƒ¨ä»¶å†…å®¹
    const content = document.createElement('div');
    content.className = 'widget-content';
    content.innerHTML = getWidgetPlaceholder(type);
    
    widget.appendChild(toolbar);
    widget.appendChild(typeLabel);
    widget.appendChild(content);
    canvas.appendChild(widget);
    
    // ä¿å­˜éƒ¨ä»¶é…ç½®
    widgetConfigs[widgetId] = {
        type: type,
        config: {}
    };
    
    // ä½¿éƒ¨ä»¶å¯æ‹–æ‹½ï¼ˆå·²åŒ…å«ç‚¹å‡»é€‰ä¸­é€»è¾‘ï¼‰
    makeWidgetDraggable(widget);
    makeWidgetResizable(widget);
}

// è·å–éƒ¨ä»¶æ ‡é¢˜
function getWidgetTitle(type) {
    const titles = {
        'list': 'ğŸ“‹ æ¸…å•è¡¨',
        'cross': 'ğŸ“Š äº¤å‰è¡¨',
        'chart': 'ğŸ“ˆ å›¾å½¢',
        'text': 'ğŸ“ æ–‡æœ¬',
        'image': 'ğŸ–¼ï¸ å›¾ç‰‡'
    };
    return titles[type] || 'éƒ¨ä»¶';
}

// è·å–éƒ¨ä»¶ç±»å‹å›¾æ ‡
function getWidgetTypeIcon(type) {
    const icons = {
        'list': 'ğŸ“‹',
        'cross': 'ğŸ“Š',
        'chart': 'ğŸ“ˆ',
        'text': 'ğŸ“',
        'image': 'ğŸ–¼ï¸'
    };
    return icons[type] || 'ğŸ“Œ';
}

// è·å–éƒ¨ä»¶å ä½å†…å®¹
function getWidgetPlaceholder(type) {
    const placeholders = {
        'list': '<div class="widget-placeholder">' + allTexts.click_widget_to_config + '</div>',
        'cross': '<div class="widget-placeholder">' + allTexts.click_widget_to_config + '</div>',
        'chart': '<div class="widget-placeholder">' + allTexts.click_widget_config_chart + '</div>',
        'text': '<div class="widget-placeholder">' + allTexts.click_widget_add_text + '</div>',
        'image': '<div class="widget-placeholder">' + allTexts.click_widget_upload_image + '</div>'
    };
    return placeholders[type] || '';
}

// å½“å‰é€‰ä¸­çš„éƒ¨ä»¶
let selectedWidgetId = null;

// é€‰ä¸­éƒ¨ä»¶
function selectWidget(widgetId) {
    // å–æ¶ˆä¹‹å‰é€‰ä¸­çš„éƒ¨ä»¶
    if (selectedWidgetId) {
        const prevWidget = document.getElementById(selectedWidgetId);
        if (prevWidget) {
            prevWidget.classList.remove('widget-selected');
        }
    }
    
    // é€‰ä¸­æ–°éƒ¨ä»¶
    selectedWidgetId = widgetId;
    const widget = document.getElementById(widgetId);
    if (widget) {
        widget.classList.add('widget-selected');
    }
    
    // åœ¨å·¦ä¾§æ˜¾ç¤ºé…ç½®
    showLeftConfig(widgetId);
}

// åœ¨å·¦ä¾§æ˜¾ç¤ºé…ç½®
function showLeftConfig(widgetId) {
    const config = widgetConfigs[widgetId];
    const panel = document.getElementById('widgetConfigPanel');
    const fieldsPanel = document.getElementById('fieldsPanel');
    const content = document.getElementById('widgetConfigContent');
    
    if (!config) return;
    
    // å¯¹äºéœ€è¦å­—æ®µæ‹–æ‹½çš„éƒ¨ä»¶ç±»å‹ï¼Œæ˜¾ç¤ºå­—æ®µé¢æ¿
    if (config.type === 'list' || config.type === 'cross' || config.type === 'chart') {
        fieldsPanel.style.display = 'block';
    }
    
    // æ ¹æ®éƒ¨ä»¶ç±»å‹æ˜¾ç¤ºä¸åŒçš„é…ç½®ç•Œé¢
    if (config.type === 'chart') {
        content.innerHTML = getChartConfigHTML(widgetId);
    } else if (config.type === 'list') {
        content.innerHTML = getListConfigHTML(widgetId);
    } else if (config.type === 'cross') {
        content.innerHTML = getCrossConfigHTML(widgetId);
    } else if (config.type === 'text') {
        content.innerHTML = getTextConfigHTML(widgetId, config);
    } else if (config.type === 'image') {
        content.innerHTML = getImageConfigHTML(widgetId);
    } else {
        content.innerHTML = `
            <div class="config-section">
                <p>è¯¥éƒ¨ä»¶ç±»å‹é…ç½®åŠŸèƒ½å³å°†æ¨å‡º...</p>
            </div>
        `;
    }
    
    // æ˜¾ç¤ºé…ç½®é¢æ¿
    panel.style.display = 'block';
}

// å…³é—­å·¦ä¾§é…ç½®
function closeLeftConfig() {
    document.getElementById('widgetConfigPanel').style.display = 'none';
    
    // å–æ¶ˆé€‰ä¸­
    if (selectedWidgetId) {
        const widget = document.getElementById(selectedWidgetId);
        if (widget) {
            widget.classList.remove('widget-selected');
        }
        selectedWidgetId = null;
    }
}

// è·å–å›¾è¡¨é…ç½®HTML
function getChartConfigHTML(widgetId) {
    if (!selectedFileId) {
        return '<div class="config-section"><p style="color: #f56565;">è¯·å…ˆé€‰æ‹©æ•°æ®æ–‡ä»¶</p></div>';
    }
    
    const config = widgetConfigs[widgetId];
    const currentChartType = config.chartType || '';
    
    return `
        <div class="config-section">
            <h4 style="margin: 0 0 10px 0; color: #2d3748;">ğŸ“Š ${allTexts.chart_config}</h4>
        </div>
        
        <div class="config-section">
            <label class="config-label">${allTexts.chart_type}</label>
            <select id="leftChartType" class="config-select" onchange="updateChartConfigOptions('${widgetId}')">
                <option value="">${allTexts.select_chart_type}</option>
                <option value="line" ${currentChartType === 'line' ? 'selected' : ''}>ğŸ“ˆ ${allTexts.line_chart}</option>
                <option value="bar" ${currentChartType === 'bar' ? 'selected' : ''}>ğŸ“Š ${allTexts.bar_chart}</option>
                <option value="area" ${currentChartType === 'area' ? 'selected' : ''}>ğŸ“Š ${allTexts.area_chart}</option>
                <option value="pie" ${currentChartType === 'pie' ? 'selected' : ''}>ğŸ¥§ ${allTexts.pie_chart}</option>
                <option value="waterfall" ${currentChartType === 'waterfall' ? 'selected' : ''}>ğŸ“ˆ ${allTexts.waterfall_chart}</option>
                <option value="scatter" ${currentChartType === 'scatter' ? 'selected' : ''}>ğŸ”µ ${allTexts.scatter_chart}</option>
                <option value="wordcloud" ${currentChartType === 'wordcloud' ? 'selected' : ''}>â˜ï¸ ${allTexts.wordcloud}</option>
                <option value="map" ${currentChartType === 'map' ? 'selected' : ''}>ğŸ—ºï¸ ${allTexts.map}</option>
                <option value="sunburst" ${currentChartType === 'sunburst' ? 'selected' : ''}>â˜€ï¸ ${allTexts.sunburst}</option>
                <option value="combo_single" ${currentChartType === 'combo_single' ? 'selected' : ''}>ğŸ“Š ${allTexts.combo_single}</option>
                <option value="combo_dual" ${currentChartType === 'combo_dual' ? 'selected' : ''}>ğŸ“Š ${allTexts.combo_dual}</option>
            </select>
        </div>
        
        <div id="chartOptionsContainer_${widgetId}">
            ${getChartTypeSpecificOptions(widgetId, currentChartType)}
        </div>
        
        <div class="config-section">
            <label class="config-label">${allTexts.theme}</label>
            <select id="leftChartTheme" class="config-select">
                <option value="purple">${allTexts.purple}</option>
                <option value="blue">${allTexts.blue}</option>
                <option value="green">${allTexts.green}</option>
                <option value="red">${allTexts.red}</option>
                <option value="orange">${allTexts.orange}</option>
                <option value="pink">${allTexts.pink}</option>
                <option value="teal">${allTexts.teal}</option>
            </select>
        </div>
        
        <div class="config-section">
            <button class="btn btn-primary" style="width: 100%;" onclick="generateChartInWidget('${widgetId}')">
                ğŸš€ ${allTexts.generate_chart_btn}
            </button>
        </div>
    `;
}

// æ›´æ–°å›¾è¡¨é…ç½®é€‰é¡¹
function updateChartConfigOptions(widgetId) {
    const chartType = document.getElementById('leftChartType').value;
    const container = document.getElementById(`chartOptionsContainer_${widgetId}`);
    if (container) {
        container.innerHTML = getChartTypeSpecificOptions(widgetId, chartType);
    }
    
    // ä¿å­˜å›¾è¡¨ç±»å‹
    widgetConfigs[widgetId].chartType = chartType;
}

// è·å–ç‰¹å®šå›¾è¡¨ç±»å‹çš„é…ç½®é€‰é¡¹
function getChartTypeSpecificOptions(widgetId, chartType) {
    if (!chartType) {
        return '<div class="config-section"><p style="font-size: 12px; color: #718096;">' + allTexts.please_select_chart_type_first + '</p></div>';
    }
    
    const config = widgetConfigs[widgetId];
    
    // è¯äº‘å›¾é…ç½®
    if (chartType === 'wordcloud') {
        return `
            <div class="config-section">
                <label class="config-label">${allTexts.text_field}</label>
                <select id="leftWordcloudTextField" class="config-select">
                    <option value="">${allTexts.select_text_field_label}</option>
                    ${currentColumns.dimensions.map(col => `<option value="${col}">${col}</option>`).join('')}
                </select>
            </div>
            
            <div class="config-section">
                <label class="config-label">${allTexts.select_weight_field}</label>
                <select id="leftWordcloudWeightField" class="config-select">
                    <option value="">${allTexts.no_weight}</option>
                    ${currentColumns.measures.map(col => `<option value="${col}">${col}</option>`).join('')}
                </select>
            </div>
            
            <div class="config-section">
                <label class="config-label">${allTexts.wordcloud_shape}</label>
                <select id="leftWordcloudShape" class="config-select">
                    <option value="rectangle">${allTexts.shape_rectangle}</option>
                    <option value="circle">${allTexts.shape_circle}</option>
                    <option value="cloud">${allTexts.shape_cloud}</option>
                    <option value="star">${allTexts.shape_star}</option>
                    <option value="heart">${allTexts.shape_heart}</option>
                    <option value="diamond">${allTexts.shape_diamond}</option>
                </select>
            </div>
        `;
    }
    
    // æ—­æ—¥å›¾é…ç½®
    if (chartType === 'sunburst') {
        return `
            <div class="config-section">
                <label class="config-label">${allTexts.dimension_hierarchy}</label>
                <div class="widget-drop-zone" id="widgetSunburstRows_${widgetId}" 
                     ondrop="widgetDrop(event, '${widgetId}', 'rows')" 
                     ondragover="allowDrop(event)">
                    <span class="drop-hint">${allTexts.drag_dimension_here}</span>
                </div>
            </div>
            
            <div class="config-section">
                <label class="config-label">${allTexts.measure_field}</label>
                <div class="widget-drop-zone" id="widgetSunburstValues_${widgetId}" 
                     ondrop="widgetDrop(event, '${widgetId}', 'values')" 
                     ondragover="allowDrop(event)">
                    <span class="drop-hint">${allTexts.drag_measure_here}</span>
                </div>
            </div>
        `;
    }
    
    // è”åˆå›¾é…ç½®
    if (chartType === 'combo_single' || chartType === 'combo_dual') {
        return `
            <div class="config-section">
                <label class="config-label">${allTexts.dimension_x_axis}</label>
                <select id="leftComboDimension" class="config-select">
                    <option value="">${allTexts.select_dimension}</option>
                    ${currentColumns.dimensions.map(col => `<option value="${col}">${col}</option>`).join('')}
                </select>
            </div>
            
            <div class="config-section">
                <label class="config-label">${allTexts.measure_fields}</label>
                <div id="comboMeasuresContainer_${widgetId}">
                    <button class="btn btn-secondary" style="width: 100%; margin-top: 5px;" onclick="addComboMeasure('${widgetId}')">
                        â• ${allTexts.add_measure}
                    </button>
                </div>
            </div>
        `;
    }
    
    // å¸¸è§„å›¾è¡¨é…ç½®ï¼ˆæŠ˜çº¿å›¾ã€æŸ±çŠ¶å›¾ã€æ•£ç‚¹å›¾ç­‰ï¼‰
    return `
        <div class="config-section">
            <label class="config-label">${allTexts.x_axis_field}</label>
            <select id="leftChartXAxis" class="config-select">
                <option value="">${allTexts.select_x_axis}</option>
                ${currentColumns.dimensions.map(col => `<option value="${col}">${col}</option>`).join('')}
            </select>
        </div>
        
        <div class="config-section">
            <label class="config-label">${allTexts.y_axis_field}</label>
            <select id="leftChartYAxis" class="config-select">
                <option value="">${allTexts.select_y_axis}</option>
                ${currentColumns.measures.map(col => `<option value="${col}">${col}</option>`).join('')}
            </select>
        </div>
        
        ${chartType === 'scatter' ? `
        <div class="config-section">
            <label class="config-label">${allTexts.group_field_optional}</label>
            <select id="leftChartGroupField" class="config-select">
                <option value="">${allTexts.no_grouping}</option>
                ${currentColumns.dimensions.map(col => `<option value="${col}">${col}</option>`).join('')}
            </select>
        </div>
        ` : ''}
    `;
}

// è·å–æ–‡æœ¬é…ç½®HTML
function getTextConfigHTML(widgetId, config) {
    const currentContent = config.config.html || config.config.text || '';
    
    return `
        <div class="config-section">
            <h4 style="margin: 0 0 10px 0; color: #2d3748;">ğŸ“ æ–‡æœ¬ç¼–è¾‘å™¨</h4>
        </div>
        
        <div class="config-section">
            <label class="config-label">æ ¼å¼å·¥å…·æ </label>
            <div class="rich-text-toolbar">
                <!-- æ–‡å­—æ ¼å¼ -->
                <div class="toolbar-group">
                    <button class="toolbar-btn" onclick="formatText('bold')" title="åŠ ç²—">
                        <strong>B</strong>
                    </button>
                    <button class="toolbar-btn" onclick="formatText('italic')" title="æ–œä½“">
                        <em>I</em>
                    </button>
                    <button class="toolbar-btn" onclick="formatText('underline')" title="ä¸‹åˆ’çº¿">
                        <u>U</u>
                    </button>
                </div>
                
                <!-- å¯¹é½æ–¹å¼ -->
                <div class="toolbar-group">
                    <button class="toolbar-btn" onclick="formatText('justifyLeft')" title="å·¦å¯¹é½">
                        â˜°
                    </button>
                    <button class="toolbar-btn" onclick="formatText('justifyCenter')" title="å±…ä¸­">
                        â˜±
                    </button>
                    <button class="toolbar-btn" onclick="formatText('justifyRight')" title="å³å¯¹é½">
                        â˜²
                    </button>
                </div>
                
                <!-- å­—ä½“å¤§å° -->
                <div class="toolbar-group">
                    <select class="toolbar-select" onchange="formatText('fontSize', this.value)" title="å­—ä½“å¤§å°">
                        <option value="">å­—å·</option>
                        <option value="1">12px</option>
                        <option value="2">14px</option>
                        <option value="3">16px</option>
                        <option value="4">18px</option>
                        <option value="5">24px</option>
                        <option value="6">32px</option>
                        <option value="7">48px</option>
                    </select>
                </div>
                
                <!-- å­—ä½“ç±»å‹ -->
                <div class="toolbar-group">
                    <select class="toolbar-select" onchange="formatText('fontName', this.value)" title="å­—ä½“">
                        <option value="">å­—ä½“</option>
                        <option value="Arial">Arial</option>
                        <option value="Microsoft YaHei">å¾®è½¯é›…é»‘</option>
                        <option value="SimSun">å®‹ä½“</option>
                        <option value="SimHei">é»‘ä½“</option>
                        <option value="KaiTi">æ¥·ä½“</option>
                        <option value="Courier New">Courier New</option>
                        <option value="Times New Roman">Times New Roman</option>
                    </select>
                </div>
                
                <!-- å­—ä½“é¢œè‰² -->
                <div class="toolbar-group">
                    <label class="toolbar-color-label" title="å­—ä½“é¢œè‰²">
                        <span>A</span>
                        <input type="color" id="textColorPicker" onchange="formatText('foreColor', this.value)" style="width: 30px; height: 24px; border: none; cursor: pointer;">
                    </label>
                </div>
                
                <!-- èƒŒæ™¯é¢œè‰² -->
                <div class="toolbar-group">
                    <label class="toolbar-color-label" title="èƒŒæ™¯é¢œè‰²">
                        <span>ğŸ¨</span>
                        <input type="color" id="textBgColorPicker" onchange="formatText('backColor', this.value)" style="width: 30px; height: 24px; border: none; cursor: pointer;">
                    </label>
                </div>
            </div>
        </div>
        
        <div class="config-section">
            <label class="config-label">æ–‡æœ¬å†…å®¹</label>
            <div id="richTextEditor" class="rich-text-editor" contenteditable="true" 
                 style="min-height: 200px; max-height: 400px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 4px; padding: 12px; background: white; font-size: 14px; line-height: 1.6;"
                 placeholder="åœ¨æ­¤è¾“å…¥æ–‡æœ¬å†…å®¹...">${currentContent}</div>
        </div>
        
        <div class="config-section">
            <button class="btn btn-primary" style="width: 100%;" onclick="saveTextInWidget('${widgetId}')">
                ğŸ’¾ ä¿å­˜æ–‡æœ¬
            </button>
        </div>
    `;
}

// è·å–å›¾ç‰‡é…ç½®HTML
function getImageConfigHTML(widgetId) {
    return `
        <div class="config-section">
            <label class="config-label">${allTexts.select_image}</label>
            <input type="file" id="leftImageFile" accept="image/*" class="config-input">
        </div>
        
        <div class="config-section">
            <button class="btn btn-primary" style="width: 100%;" onclick="uploadImageInWidget('${widgetId}')">
                ${allTexts.upload_image}
            </button>
        </div>
    `;
}

// è·å–æ¸…å•è¡¨é…ç½®HTML
function getListConfigHTML(widgetId) {
    if (!selectedFileId) {
        return '<div class="config-section"><p style="color: #f56565;">' + allTexts.select_data_file_first + '</p></div>';
    }
    
    // åˆå§‹åŒ–è¯¥éƒ¨ä»¶çš„å­—æ®µé…ç½®
    if (!widgetConfigs[widgetId].fields) {
        widgetConfigs[widgetId].fields = {
            rows: [],
            columns: [],
            values: []
        };
    }
    
    const config = widgetConfigs[widgetId];
    const hasMetadata = config.metadata;
    
    return `
        <div class="config-section" style="display: flex; justify-content: space-between; align-items: center;">
            <h4 style="margin: 0; color: #2d3748;">ğŸ“‹ ${allTexts.list_table_config}</h4>
            ${hasMetadata ? '<button class="btn-properties" onclick="showWidgetProperties(\'' + widgetId + '\')">ğŸ“Š ' + allTexts.properties + '</button>' : ''}
        </div>
        
        <div class="config-section">
            <p style="font-size: 12px; color: #718096; margin: 0;">${allTexts.from_left_drag_dim_to_row}</p>
        </div>
        
        <div class="config-section">
            <label class="config-label">${allTexts.row_fields}</label>
            <div class="widget-drop-zone" id="widgetRows_${widgetId}" 
                 ondrop="widgetDrop(event, '${widgetId}', 'rows')" 
                 ondragover="allowDrop(event)">
                <span class="drop-hint">${allTexts.drag_field_here}</span>
            </div>
        </div>
        
        <div class="config-section">
            <label class="config-label">${allTexts.column_fields}</label>
            <div class="widget-drop-zone" id="widgetColumns_${widgetId}" 
                 ondrop="widgetDrop(event, '${widgetId}', 'columns')" 
                 ondragover="allowDrop(event)">
                <span class="drop-hint">${allTexts.drag_field_here}</span>
            </div>
        </div>
        
        <div class="config-section">
            <label class="config-label">${allTexts.value_fields}</label>
            <div class="widget-drop-zone" id="widgetValues_${widgetId}" 
                 ondrop="widgetDrop(event, '${widgetId}', 'values')" 
                 ondragover="allowDrop(event)">
                <span class="drop-hint">${allTexts.drag_field_here}</span>
            </div>
        </div>
        
        <div class="config-section">
            <button class="btn btn-primary" style="width: 100%;" onclick="generateListInWidget('${widgetId}')">
                ğŸš€ ${allTexts.generate_list_table}
            </button>
        </div>
    `;
}

// è·å–äº¤å‰è¡¨é…ç½®HTML
function getCrossConfigHTML(widgetId) {
    if (!selectedFileId) {
        return '<div class="config-section"><p style="color: #f56565;">' + allTexts.select_data_file_first + '</p></div>';
    }
    
    // åˆå§‹åŒ–è¯¥éƒ¨ä»¶çš„å­—æ®µé…ç½®
    if (!widgetConfigs[widgetId].fields) {
        widgetConfigs[widgetId].fields = {
            rows: [],
            columns: [],
            values: []
        };
    }
    
    const config = widgetConfigs[widgetId];
    const hasMetadata = config.metadata;
    
    return `
        <div class="config-section" style="display: flex; justify-content: space-between; align-items: center;">
            <h4 style="margin: 0; color: #2d3748;">ğŸ“Š ${allTexts.cross_table_config}</h4>
            ${hasMetadata ? '<button class="btn-properties" onclick="showWidgetProperties(\'' + widgetId + '\')">ğŸ“Š ' + allTexts.properties + '</button>' : ''}
        </div>
        
        <div class="config-section">
            <p style="font-size: 12px; color: #718096; margin: 0;">${allTexts.from_left_drag_dim_to_row}</p>
        </div>
        
        <div class="config-section">
            <label class="config-label">${allTexts.row_fields}</label>
            <div class="widget-drop-zone" id="widgetRows_${widgetId}" 
                 ondrop="widgetDrop(event, '${widgetId}', 'rows')" 
                 ondragover="allowDrop(event)">
                <span class="drop-hint">${allTexts.drag_field_here}</span>
            </div>
        </div>
        
        <div class="config-section">
            <label class="config-label">${allTexts.column_fields}</label>
            <div class="widget-drop-zone" id="widgetColumns_${widgetId}" 
                 ondrop="widgetDrop(event, '${widgetId}', 'columns')" 
                 ondragover="allowDrop(event)">
                <span class="drop-hint">${allTexts.drag_field_here}</span>
            </div>
        </div>
        
        <div class="config-section">
            <label class="config-label">${allTexts.value_fields}</label>
            <div class="widget-drop-zone" id="widgetValues_${widgetId}" 
                 ondrop="widgetDrop(event, '${widgetId}', 'values')" 
                 ondragover="allowDrop(event)">
                <span class="drop-hint">${allTexts.drag_field_here}</span>
            </div>
        </div>
        
        <div class="config-section">
            <button class="btn btn-primary" style="width: 100%;" onclick="generateCrossInWidget('${widgetId}')">
                ğŸš€ ${allTexts.generate_cross_table}
            </button>
        </div>
    `;
}

// æ·»åŠ è”åˆå›¾åº¦é‡
function addComboMeasure(widgetId) {
    const config = widgetConfigs[widgetId];
    if (!config.comboMeasures) {
        config.comboMeasures = [];
    }
    
    const measureIndex = config.comboMeasures.length;
    config.comboMeasures.push({
        field: '',
        aggregation: 'sum',
        chart_type: 'bar'
    });
    
    const container = document.getElementById(`comboMeasuresContainer_${widgetId}`);
    const measureDiv = document.createElement('div');
    measureDiv.className = 'combo-measure-item';
    measureDiv.style.cssText = 'padding: 10px; background: #f7fafc; border-radius: 4px; margin-top: 10px;';
    
    measureDiv.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <span style="font-weight: 600; font-size: 12px;">åº¦é‡ ${measureIndex + 1}</span>
            <button onclick="removeComboMeasure('${widgetId}', ${measureIndex})" style="background: #f56565; color: white; border: none; border-radius: 3px; padding: 2px 8px; cursor: pointer;">Ã—</button>
        </div>
        <select id="comboMeasureField_${widgetId}_${measureIndex}" class="config-select" style="margin-bottom: 5px;" onchange="updateComboMeasure('${widgetId}', ${measureIndex}, 'field', this.value)">
            <option value="">-- é€‰æ‹©å­—æ®µ --</option>
            ${currentColumns.measures.map(col => `<option value="${col}">${col}</option>`).join('')}
        </select>
        <select id="comboMeasureAgg_${widgetId}_${measureIndex}" class="config-select" style="margin-bottom: 5px;" onchange="updateComboMeasure('${widgetId}', ${measureIndex}, 'aggregation', this.value)">
            <option value="sum">æ±‚å’Œ</option>
            <option value="avg">å¹³å‡</option>
            <option value="count">è®¡æ•°</option>
            <option value="max">æœ€å¤§å€¼</option>
            <option value="min">æœ€å°å€¼</option>
        </select>
        <select id="comboMeasureType_${widgetId}_${measureIndex}" class="config-select" onchange="updateComboMeasure('${widgetId}', ${measureIndex}, 'chart_type', this.value)">
            <option value="bar">æŸ±çŠ¶å›¾</option>
            <option value="line">æŠ˜çº¿å›¾</option>
        </select>
    `;
    
    container.insertBefore(measureDiv, container.querySelector('button'));
}

// æ›´æ–°è”åˆå›¾åº¦é‡
function updateComboMeasure(widgetId, index, key, value) {
    const config = widgetConfigs[widgetId];
    if (config.comboMeasures && config.comboMeasures[index]) {
        config.comboMeasures[index][key] = value;
    }
}

// ç§»é™¤è”åˆå›¾åº¦é‡
function removeComboMeasure(widgetId, index) {
    const config = widgetConfigs[widgetId];
    if (config.comboMeasures) {
        config.comboMeasures.splice(index, 1);
        // é‡æ–°æ¸²æŸ“
        updateChartConfigOptions(widgetId);
    }
}

// åœ¨éƒ¨ä»¶ä¸­ç”Ÿæˆå›¾è¡¨
function generateChartInWidget(widgetId) {
    const chartType = document.getElementById('leftChartType').value;
    const theme = document.getElementById('leftChartTheme').value;
    
    if (!chartType) {
        alert('è¯·é€‰æ‹©å›¾è¡¨ç±»å‹');
        return;
    }
    
    if (!selectedFileId) {
        alert('è¯·å…ˆé€‰æ‹©æ•°æ®æ–‡ä»¶');
        return;
    }
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    const widget = document.getElementById(widgetId);
    const content = widget.querySelector('.widget-content');
    content.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%;"><p>â³ æ­£åœ¨ç”Ÿæˆå›¾è¡¨...</p></div>';
    
    // æ ¹æ®å›¾è¡¨ç±»å‹è°ƒç”¨ä¸åŒçš„API
    if (chartType === 'wordcloud') {
        generateWordcloudInWidget(widgetId, theme);
    } else if (chartType === 'sunburst') {
        generateSunburstInWidget(widgetId, theme);
    } else if (chartType === 'combo_single' || chartType === 'combo_dual') {
        generateComboInWidget(widgetId, chartType, theme);
    } else {
        generateRegularChartInWidget(widgetId, chartType, theme);
    }
}

// ç”Ÿæˆè¯äº‘å›¾
function generateWordcloudInWidget(widgetId, theme) {
    const textField = document.getElementById('leftWordcloudTextField').value;
    const weightField = document.getElementById('leftWordcloudWeightField').value;
    const shape = document.getElementById('leftWordcloudShape').value;
    
    if (!textField) {
        alert('è¯·é€‰æ‹©æ–‡æœ¬å­—æ®µ');
        return;
    }
    
    fetch('/api/chart/wordcloud/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            file_id: selectedFileId,
            text_field: textField,
            weight_field: weightField || null,
            shape: shape,
            theme: theme
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayChartInWidget(widgetId, data);
        } else {
            alert('ç”Ÿæˆå¤±è´¥: ' + data.message);
        }
    })
    .catch(error => {
        alert('ç”Ÿæˆå¤±è´¥: ' + error.message);
    });
}

// ç”Ÿæˆæ—­æ—¥å›¾
function generateSunburstInWidget(widgetId, theme) {
    const config = widgetConfigs[widgetId];
    const rows = config.fields?.rows || [];
    const values = config.fields?.values || [];
    
    if (rows.length === 0) {
        alert('æ—­æ—¥å›¾éœ€è¦è‡³å°‘ä¸€ä¸ªç»´åº¦å­—æ®µï¼ˆå±‚çº§ï¼‰');
        return;
    }
    
    if (values.length === 0) {
        alert('æ—­æ—¥å›¾éœ€è¦ä¸€ä¸ªåº¦é‡å­—æ®µï¼ˆå€¼ï¼‰');
        return;
    }
    
    fetch('/api/chart/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            file_id: selectedFileId,
            chart_type: 'sunburst',
            rows: rows,
            values: values,
            theme: theme
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayChartInWidget(widgetId, data);
        } else {
            alert('ç”Ÿæˆå¤±è´¥: ' + data.message);
        }
    })
    .catch(error => {
        alert('ç”Ÿæˆå¤±è´¥: ' + error.message);
    });
}

// ç”Ÿæˆè”åˆå›¾
function generateComboInWidget(widgetId, chartType, theme) {
    const dimension = document.getElementById('leftComboDimension').value;
    const config = widgetConfigs[widgetId];
    const measures = config.comboMeasures || [];
    
    if (!dimension) {
        alert('è¯·é€‰æ‹©ç»´åº¦å­—æ®µï¼ˆXè½´ï¼‰');
        return;
    }
    
    if (measures.length === 0) {
        alert('è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªåº¦é‡å­—æ®µ');
        return;
    }
    
    // éªŒè¯æ‰€æœ‰åº¦é‡éƒ½å·²é…ç½®
    for (let i = 0; i < measures.length; i++) {
        if (!measures[i].field) {
            alert(`è¯·ä¸ºåº¦é‡ ${i + 1} é€‰æ‹©å­—æ®µ`);
            return;
        }
    }
    
    fetch('/api/chart/combo/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            file_id: selectedFileId,
            chart_type: chartType,
            dimension: dimension,
            measures: measures,
            theme: theme
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayChartInWidget(widgetId, data);
        } else {
            alert('ç”Ÿæˆå¤±è´¥: ' + data.message);
        }
    })
    .catch(error => {
        alert('ç”Ÿæˆå¤±è´¥: ' + error.message);
    });
}

// ç”Ÿæˆå¸¸è§„å›¾è¡¨
function generateRegularChartInWidget(widgetId, chartType, theme) {
    const xAxis = document.getElementById('leftChartXAxis').value;
    const yAxis = document.getElementById('leftChartYAxis').value;
    const groupField = document.getElementById('leftChartGroupField')?.value || '';
    
    if (!xAxis || !yAxis) {
        alert('è¯·é€‰æ‹©Xè½´å’ŒYè½´å­—æ®µ');
        return;
    }
    
    fetch('/api/chart/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            file_id: selectedFileId,
            chart_type: chartType,
            x_axis: xAxis,
            y_axis: yAxis,
            group_field: groupField,
            theme: theme
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayChartInWidget(widgetId, data);
        } else {
            alert('ç”Ÿæˆå¤±è´¥: ' + data.message);
        }
    })
    .catch(error => {
        alert('ç”Ÿæˆå¤±è´¥: ' + error.message);
    });
}

// åœ¨éƒ¨ä»¶ä¸­æ˜¾ç¤ºå›¾è¡¨
function displayChartInWidget(widgetId, data) {
    const widget = document.getElementById(widgetId);
    const content = widget.querySelector('.widget-content');
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯HTMLç±»å‹çš„å›¾è¡¨ï¼ˆæ—­æ—¥å›¾ã€åœ°å›¾ç­‰ï¼‰
    if (data.is_html || data.chart_type === 'sunburst' || data.chart_type === 'map') {
        // HTMLç±»å‹å›¾è¡¨ä½¿ç”¨iframeæ˜¾ç¤ºï¼Œç§»é™¤paddingè®©iframeå®Œå…¨å¡«å……
        content.style.padding = '0';
        let iframeSrc = '';
        if (data.chart_url) {
            // åœ°å›¾ç­‰ä½¿ç”¨chart_url
            iframeSrc = data.chart_url;
        } else if (data.filename) {
            // æ—­æ—¥å›¾ç­‰ä½¿ç”¨filename
            iframeSrc = `/charts/${data.filename}`;
        }
        
        // åˆ›å»ºiframeå¹¶æ·»åŠ åŠ è½½å®Œæˆç›‘å¬
        const iframe = document.createElement('iframe');
        iframe.src = iframeSrc;
        iframe.style.cssText = 'width: 100%; height: 100%; border: none; display: block;';
        
        // iframeåŠ è½½å®Œæˆåè§¦å‘å†…éƒ¨å›¾è¡¨çš„resize
        iframe.onload = function() {
            try {
                // å°è¯•è®¿é—®iframeå†…å®¹å¹¶è§¦å‘resize
                setTimeout(function() {
                    if (iframe.contentWindow) {
                        iframe.contentWindow.dispatchEvent(new Event('resize'));
                    }
                }, 200);
            } catch (e) {
                console.log('æ— æ³•è®¿é—®iframeå†…å®¹ï¼ˆå¯èƒ½æ˜¯è·¨åŸŸé™åˆ¶ï¼‰');
            }
        };
        
        content.innerHTML = '';
        content.appendChild(iframe);
    } else {
        // å…¶ä»–å›¾è¡¨ä½¿ç”¨base64å›¾ç‰‡ï¼Œæ¢å¤padding
        content.style.padding = '15px';
        content.innerHTML = `<img src="${data.image}" style="width: 100%; height: 100%; object-fit: contain;">`;
    }
    
    // ä¿å­˜é…ç½®
    widgetConfigs[widgetId].chartGenerated = true;
}

// å¯Œæ–‡æœ¬æ ¼å¼åŒ–å‡½æ•°
function formatText(command, value = null) {
    // ç¡®ä¿ç¼–è¾‘å™¨è·å¾—ç„¦ç‚¹
    const editor = document.getElementById('richTextEditor');
    if (!editor) return;
    
    editor.focus();
    
    // æ‰§è¡Œæ ¼å¼åŒ–å‘½ä»¤
    if (value) {
        document.execCommand(command, false, value);
    } else {
        document.execCommand(command, false, null);
    }
    
    // é‡ç½®é€‰æ‹©æ¡†çš„å€¼ï¼ˆå¯é€‰ï¼‰
    if (command === 'fontSize' || command === 'fontName') {
        setTimeout(() => {
            const select = event.target;
            if (select && select.tagName === 'SELECT') {
                select.selectedIndex = 0;
            }
        }, 100);
    }
}

// åœ¨éƒ¨ä»¶ä¸­ä¿å­˜æ–‡æœ¬
function saveTextInWidget(widgetId) {
    const editor = document.getElementById('richTextEditor');
    if (!editor) {
        alert('æ‰¾ä¸åˆ°æ–‡æœ¬ç¼–è¾‘å™¨');
        return;
    }
    
    const htmlContent = editor.innerHTML;
    
    const config = widgetConfigs[widgetId];
    config.config.html = htmlContent;
    config.config.text = editor.innerText; // ä¿å­˜çº¯æ–‡æœ¬å¤‡ä»½
    
    // æ›´æ–°éƒ¨ä»¶æ˜¾ç¤º
    const widget = document.getElementById(widgetId);
    const content = widget.querySelector('.widget-content');
    content.innerHTML = `<div style="padding: 15px; overflow: auto; height: 100%;">${htmlContent}</div>`;
    
    alert('âœ… æ–‡æœ¬å·²ä¿å­˜');
}

// åœ¨éƒ¨ä»¶ä¸­ä¸Šä¼ å›¾ç‰‡
function uploadImageInWidget(widgetId) {
    const fileInput = document.getElementById('leftImageFile');
    const file = fileInput.files[0];
    
    if (!file) {
        alert(allTexts.please_select_image);
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const config = widgetConfigs[widgetId];
        config.config.imageUrl = e.target.result;
        
        // æ›´æ–°éƒ¨ä»¶æ˜¾ç¤º
        const widget = document.getElementById(widgetId);
        const content = widget.querySelector('.widget-content');
        content.innerHTML = `<img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: contain;">`;
        
        alert('å›¾ç‰‡å·²ä¸Šä¼ ');
    };
    reader.readAsDataURL(file);
}

// éƒ¨ä»¶æ‹–æ‹½å¤„ç†
function widgetDrop(event, widgetId, zone) {
    event.preventDefault();
    
    // è·å–å­—æ®µæ•°æ®ï¼ˆå…¼å®¹ä¸¤ç§æ ¼å¼ï¼‰
    const fieldName = event.dataTransfer.getData('columnName') || event.dataTransfer.getData('text/plain');
    const fieldType = event.dataTransfer.getData('columnType') || event.dataTransfer.getData('field-type');
    
    if (!fieldName) return;
    
    const config = widgetConfigs[widgetId];
    if (!config.fields) {
        config.fields = { rows: [], columns: [], values: [] };
    }
    
    // æ·»åŠ å­—æ®µåˆ°ç›¸åº”åŒºåŸŸ
    if (!config.fields[zone].includes(fieldName)) {
        config.fields[zone].push(fieldName);
    }
    
    // æ›´æ–°æ˜¾ç¤ºï¼ˆåŒ…æ‹¬æ—­æ—¥å›¾çš„ç‰¹æ®Šdrop zoneï¼‰
    const chartType = config.chartType;
    if (chartType === 'sunburst') {
        updateWidgetDropZone(widgetId, zone, 'widgetSunburst');
    } else {
        updateWidgetDropZone(widgetId, zone);
    }
}

// æ›´æ–°éƒ¨ä»¶æ‹–æ‹½åŒºåŸŸæ˜¾ç¤º
function updateWidgetDropZone(widgetId, zone, prefix = 'widget') {
    // æ„å»ºdrop zoneçš„ID
    const capitalizedZone = zone.charAt(0).toUpperCase() + zone.slice(1);
    const dropZoneId = `${prefix}${capitalizedZone}_${widgetId}`;
    const dropZone = document.getElementById(dropZoneId);
    
    if (!dropZone) return;
    
    const config = widgetConfigs[widgetId];
    const fields = config.fields ? config.fields[zone] : [];
    
    if (!fields || fields.length === 0) {
        dropZone.innerHTML = '<span class="drop-hint">æ‹–æ‹½å­—æ®µåˆ°æ­¤å¤„</span>';
        return;
    }
    
    let html = '';
    fields.forEach((field, index) => {
        html += `
            <div class="field-tag" style="display: inline-flex; align-items: center; background: #e2e8f0; padding: 5px 10px; margin: 3px; border-radius: 4px; font-size: 12px;">
                <span>${field}</span>
                <button onclick="removeWidgetField('${widgetId}', '${zone}', ${index})" 
                        style="background: none; border: none; color: #e53e3e; margin-left: 8px; cursor: pointer; font-weight: bold;">Ã—</button>
            </div>
        `;
    });
    
    dropZone.innerHTML = html;
}

// ä»éƒ¨ä»¶ä¸­ç§»é™¤å­—æ®µ
function removeWidgetField(widgetId, zone, index) {
    const config = widgetConfigs[widgetId];
    if (config.fields && config.fields[zone]) {
        config.fields[zone].splice(index, 1);
        
        // æ ¹æ®å›¾è¡¨ç±»å‹æ›´æ–°æ˜¾ç¤º
        const chartType = config.chartType;
        if (chartType === 'sunburst') {
            updateWidgetDropZone(widgetId, zone, 'widgetSunburst');
        } else {
            updateWidgetDropZone(widgetId, zone);
        }
    }
}

// åœ¨éƒ¨ä»¶ä¸­ç”Ÿæˆæ¸…å•è¡¨
function generateListInWidget(widgetId) {
    if (!selectedFileId) {
        alert('è¯·å…ˆé€‰æ‹©æ•°æ®æ–‡ä»¶');
        return;
    }
    
    const config = widgetConfigs[widgetId];
    const fields = config.fields || { rows: [], columns: [], values: [] };
    
    showLoading('æ­£åœ¨ç”Ÿæˆæ¸…å•è¡¨...');
    
    fetch('/api/table/generate', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            file_id: selectedFileId,
            table_type: 'list',
            rows: fields.rows,
            columns: fields.columns,
            values: fields.values
        })
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            displayTableInWidget(widgetId, data);
        } else {
            alert('ç”Ÿæˆå¤±è´¥: ' + data.message);
        }
    })
    .catch(error => {
        hideLoading();
        alert('ç”Ÿæˆå¤±è´¥: ' + error.message);
    });
}

// åœ¨éƒ¨ä»¶ä¸­ç”Ÿæˆäº¤å‰è¡¨
function generateCrossInWidget(widgetId) {
    if (!selectedFileId) {
        alert('è¯·å…ˆé€‰æ‹©æ•°æ®æ–‡ä»¶');
        return;
    }
    
    const config = widgetConfigs[widgetId];
    const fields = config.fields || { rows: [], columns: [], values: [] };
    
    // éªŒè¯å¿…è¦å­—æ®µ
    if (fields.values.length === 0) {
        alert('äº¤å‰è¡¨éœ€è¦è‡³å°‘ä¸€ä¸ªå€¼å­—æ®µ');
        return;
    }
    
    if (fields.rows.length === 0 && fields.columns.length === 0) {
        alert('äº¤å‰è¡¨éœ€è¦è‡³å°‘ä¸€ä¸ªè¡Œå­—æ®µæˆ–åˆ—å­—æ®µ');
        return;
    }
    
    showLoading('æ­£åœ¨ç”Ÿæˆäº¤å‰è¡¨...');
    
    fetch('/api/table/generate', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            file_id: selectedFileId,
            table_type: 'cross',
            rows: fields.rows,
            columns: fields.columns,
            values: fields.values
        })
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            displayTableInWidget(widgetId, data);
        } else {
            alert('ç”Ÿæˆå¤±è´¥: ' + data.message);
        }
    })
    .catch(error => {
        hideLoading();
        alert('ç”Ÿæˆå¤±è´¥: ' + error.message);
    });
}

// åœ¨éƒ¨ä»¶ä¸­æ˜¾ç¤ºè¡¨æ ¼
function displayTableInWidget(widgetId, data) {
    const widget = document.getElementById(widgetId);
    const content = widget.querySelector('.widget-content');
    
    // ä¿å­˜è¡¨æ ¼å…ƒæ•°æ®åˆ°é…ç½®ä¸­
    const config = widgetConfigs[widgetId];
    if (config) {
        config.metadata = {
            table_type: data.table_type,
            total_rows: data.total_rows,
            displayed_rows: data.displayed_rows,
            columns: data.columns,
            generated_at: new Date().toLocaleString('zh-CN')
        };
    }
    
    // åªæ˜¾ç¤ºè¡¨æ ¼ï¼Œä¸æ˜¾ç¤ºæ ‡é¢˜ä¿¡æ¯ï¼ˆä¿æŒç®€æ´ï¼‰
    let html = '<div class="widget-table-container" style="width: 100%; height: 100%; overflow: auto;">';
    html += '<table class="widget-data-table" style="width: 100%; border-collapse: collapse; font-size: 12px;">';
    
    // è¡¨å¤´
    html += '<thead><tr>';
    data.columns.forEach(col => {
        html += `<th style="background: #f7fafc; border: 1px solid #e2e8f0; padding: 8px; text-align: left; font-weight: 600; color: #2d3748;">${col}</th>`;
    });
    html += '</tr></thead>';
    
    // è¡¨ä½“
    html += '<tbody>';
    data.data.forEach(row => {
        html += '<tr>';
        row.forEach(cell => {
            const displayValue = typeof cell === 'number' ? cell.toLocaleString() : cell;
            html += `<td style="border: 1px solid #e2e8f0; padding: 8px; color: #4a5568;">${displayValue}</td>`;
        });
        html += '</tr>';
    });
    html += '</tbody>';
    
    html += '</table></div>';
    
    content.innerHTML = html;
}

// åˆ é™¤éƒ¨ä»¶
function deleteWidget(widgetId) {
    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªéƒ¨ä»¶å—ï¼Ÿ')) {
        document.getElementById(widgetId).remove();
        delete widgetConfigs[widgetId];
        
        // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰é€‰ä¸­çš„éƒ¨ä»¶ï¼Œå…³é—­é…ç½®é¢æ¿
        if (selectedWidgetId === widgetId) {
            closeLeftConfig();
        }
        
        // æ£€æŸ¥ç”»å¸ƒæ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºåˆ™æ˜¾ç¤ºå ä½ç¬¦
        const canvas = document.getElementById('dashboardCanvas');
        if (canvas.children.length === 0) {
            canvas.innerHTML = `
                <div class="canvas-placeholder">
                    <div class="placeholder-icon">ğŸ“Š</div>
                    <p>è¯·ä»ä¸Šæ–¹æ‹–æ‹½éƒ¨ä»¶åˆ°æ­¤å¤„åˆ›å»ºä»ªè¡¨ç›˜</p>
                    <p class="placeholder-hint">æ”¯æŒæ¸…å•è¡¨ã€äº¤å‰è¡¨ã€å›¾å½¢ã€æ–‡æœ¬å’Œå›¾ç‰‡</p>
                </div>
            `;
        }
    }
}

// æ‰“å¼€å›¾è¡¨é…ç½®
function openChartConfig(widgetId) {
    if (!selectedFileId) {
        alert('è¯·å…ˆé€‰æ‹©æ•°æ®æ–‡ä»¶');
        return;
    }
    document.getElementById('chartConfigModal').style.display = 'flex';
}

// å…³é—­å›¾è¡¨é…ç½®
function closeChartConfig(event) {
    if (event && event.target !== event.currentTarget) return;
    document.getElementById('chartConfigModal').style.display = 'none';
}

// æ˜¾ç¤ºéƒ¨ä»¶å±æ€§
function showWidgetProperties(widgetId) {
    const config = widgetConfigs[widgetId];
    if (!config || !config.metadata) {
        alert('æš‚æ— å±æ€§ä¿¡æ¯');
        return;
    }
    
    const metadata = config.metadata;
    const typeText = metadata.table_type === 'list' ? 'æ¸…å•è¡¨' : 'äº¤å‰è¡¨';
    const typeIcon = metadata.table_type === 'list' ? 'ğŸ“‹' : 'ğŸ“Š';
    
    // åˆ›å»ºå¼¹çª—
    const modal = document.createElement('div');
    modal.className = 'properties-modal-overlay';
    modal.onclick = function(e) {
        if (e.target === modal) {
            closePropertiesModal();
        }
    };
    
    const modalContent = document.createElement('div');
    modalContent.className = 'properties-modal-content';
    modalContent.onclick = function(e) {
        e.stopPropagation();
    };
    
    let html = `
        <div class="properties-modal-header">
            <h3>${typeIcon} ${typeText}å±æ€§</h3>
            <button class="properties-modal-close" onclick="closePropertiesModal()">&times;</button>
        </div>
        <div class="properties-modal-body">
            <div class="property-item">
                <span class="property-label">ç±»å‹ï¼š</span>
                <span class="property-value">${typeIcon} ${typeText}</span>
            </div>
            <div class="property-item">
                <span class="property-label">æ€»è¡Œæ•°ï¼š</span>
                <span class="property-value">${metadata.total_rows} è¡Œ</span>
            </div>
    `;
    
    if (metadata.displayed_rows) {
        html += `
            <div class="property-item">
                <span class="property-label">æ˜¾ç¤ºè¡Œæ•°ï¼š</span>
                <span class="property-value">${metadata.displayed_rows} è¡Œ</span>
            </div>
        `;
    }
    
    html += `
            <div class="property-item">
                <span class="property-label">åˆ—æ•°ï¼š</span>
                <span class="property-value">${metadata.columns.length} åˆ—</span>
            </div>
            <div class="property-item">
                <span class="property-label">åˆ—åï¼š</span>
                <span class="property-value">${metadata.columns.join(', ')}</span>
            </div>
            <div class="property-item">
                <span class="property-label">ç”Ÿæˆæ—¶é—´ï¼š</span>
                <span class="property-value">${metadata.generated_at}</span>
            </div>
        </div>
        <div class="properties-modal-footer">
            <button class="btn btn-secondary" onclick="closePropertiesModal()">å…³é—­</button>
        </div>
    `;
    
    modalContent.innerHTML = html;
    modal.appendChild(modalContent);
    document.body.appendChild(modal);
}

// å…³é—­å±æ€§å¼¹çª—
function closePropertiesModal() {
    const modal = document.querySelector('.properties-modal-overlay');
    if (modal) {
        modal.remove();
    }
}

// æ‰“å¼€æ–‡æœ¬ç¼–è¾‘
function openTextEdit(widgetId) {
    const config = widgetConfigs[widgetId];
    document.getElementById('textContentInput').value = config.config.text || '';
    document.getElementById('textFontSizeSelect').value = config.config.fontSize || '16';
    document.getElementById('textEditModal').style.display = 'flex';
}

// å…³é—­æ–‡æœ¬ç¼–è¾‘
function closeTextEdit(event) {
    if (event && event.target !== event.currentTarget) return;
    document.getElementById('textEditModal').style.display = 'none';
}

// ä¿å­˜æ–‡æœ¬å†…å®¹
function saveTextContent() {
    const text = document.getElementById('textContentInput').value;
    const fontSize = document.getElementById('textFontSizeSelect').value;
    
    const config = widgetConfigs[currentEditingWidget];
    config.config.text = text;
    config.config.fontSize = fontSize;
    
    // æ›´æ–°éƒ¨ä»¶æ˜¾ç¤º
    const widget = document.getElementById(currentEditingWidget);
    const content = widget.querySelector('.widget-content');
    content.innerHTML = `<div style="font-size: ${fontSize}px; padding: 10px;">${text}</div>`;
    
    closeTextEdit();
}

// æ‰“å¼€å›¾ç‰‡ä¸Šä¼ 
function openImageUpload(widgetId) {
    document.getElementById('imageUploadModal').style.display = 'flex';
}

// å…³é—­å›¾ç‰‡ä¸Šä¼ 
function closeImageUpload(event) {
    if (event && event.target !== event.currentTarget) return;
    document.getElementById('imageUploadModal').style.display = 'none';
}

// ä¸Šä¼ å›¾ç‰‡
function uploadImage() {
    const fileInput = document.getElementById('imageFileInput');
    const file = fileInput.files[0];
    
    if (!file) {
        alert(allTexts.please_select_image);
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const config = widgetConfigs[currentEditingWidget];
        config.config.imageUrl = e.target.result;
        
        // æ›´æ–°éƒ¨ä»¶æ˜¾ç¤º
        const widget = document.getElementById(currentEditingWidget);
        const content = widget.querySelector('.widget-content');
        content.innerHTML = `<img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: contain;">`;
        
        closeImageUpload();
    };
    reader.readAsDataURL(file);
}

// ä½¿éƒ¨ä»¶å¯æ‹–æ‹½
function makeWidgetDraggable(widget) {
    let isDragging = false;
    let hasMoved = false;
    let currentX, currentY, initialX, initialY;
    let startX, startY;
    
    widget.addEventListener('mousedown', dragStart);
    
    function dragStart(e) {
        // å¦‚æœç‚¹å‡»çš„æ˜¯æŒ‰é’®æˆ–è°ƒæ•´æ‰‹æŸ„ï¼Œä¸å¤„ç†
        if (e.target.classList.contains('widget-tool-btn') || 
            e.target.classList.contains('resizer') ||
            e.target.closest('.widget-tool-btn') ||
            e.target.closest('.resizer')) {
            return;
        }
        
        // è®°å½•èµ·å§‹ä½ç½®
        startX = e.clientX;
        startY = e.clientY;
        initialX = e.clientX - widget.offsetLeft;
        initialY = e.clientY - widget.offsetTop;
        hasMoved = false;
        
        // æ·»åŠ ç§»åŠ¨ç›‘å¬
        document.addEventListener('mousemove', checkDrag);
        document.addEventListener('mouseup', dragEnd);
    }
    
    function checkDrag(e) {
        // è®¡ç®—ç§»åŠ¨è·ç¦»
        const deltaX = Math.abs(e.clientX - startX);
        const deltaY = Math.abs(e.clientY - startY);
        
        // å¦‚æœç§»åŠ¨è¶…è¿‡5åƒç´ ï¼Œè®¤ä¸ºæ˜¯æ‹–æ‹½
        if (deltaX > 5 || deltaY > 5) {
            if (!isDragging) {
                isDragging = true;
                hasMoved = true;
                widget.style.cursor = 'move';
                // ç§»é™¤æ£€æŸ¥ç›‘å¬ï¼Œæ·»åŠ æ‹–æ‹½ç›‘å¬
                document.removeEventListener('mousemove', checkDrag);
                document.addEventListener('mousemove', drag);
            }
        }
    }
    
    function drag(e) {
        if (!isDragging) return;
        
        e.preventDefault();
        currentX = e.clientX - initialX;
        currentY = e.clientY - initialY;
        
        widget.style.left = currentX + 'px';
        widget.style.top = currentY + 'px';
    }
    
    function dragEnd(e) {
        document.removeEventListener('mousemove', checkDrag);
        document.removeEventListener('mousemove', drag);
        document.removeEventListener('mouseup', dragEnd);
        
        isDragging = false;
        widget.style.cursor = 'pointer';
        
        // å¦‚æœæ²¡æœ‰ç§»åŠ¨ï¼Œè§¦å‘ç‚¹å‡»é€‰ä¸­
        if (!hasMoved) {
            selectWidget(widget.id);
        }
        
        hasMoved = false;
    }
}

// ä½¿éƒ¨ä»¶å¯è°ƒæ•´å¤§å°
function makeWidgetResizable(widget) {
    const resizers = ['nw', 'ne', 'sw', 'se', 'n', 's', 'e', 'w'];
    
    resizers.forEach(pos => {
        const resizer = document.createElement('div');
        resizer.className = `resizer resizer-${pos}`;
        widget.appendChild(resizer);
        
        resizer.addEventListener('mousedown', function(e) {
            e.stopPropagation();
            initResize(e, widget, pos);
        });
    });
}

// åˆå§‹åŒ–è°ƒæ•´å¤§å°
function initResize(e, widget, position) {
    const startX = e.clientX;
    const startY = e.clientY;
    const startWidth = widget.offsetWidth;
    const startHeight = widget.offsetHeight;
    const startLeft = widget.offsetLeft;
    const startTop = widget.offsetTop;
    
    function resize(e) {
        const dx = e.clientX - startX;
        const dy = e.clientY - startY;
        
        if (position.includes('e')) {
            widget.style.width = (startWidth + dx) + 'px';
        }
        if (position.includes('s')) {
            widget.style.height = (startHeight + dy) + 'px';
        }
        if (position.includes('w')) {
            widget.style.width = (startWidth - dx) + 'px';
            widget.style.left = (startLeft + dx) + 'px';
        }
        if (position.includes('n')) {
            widget.style.height = (startHeight - dy) + 'px';
            widget.style.top = (startTop + dy) + 'px';
        }
    }
    
    function stopResize() {
        document.removeEventListener('mousemove', resize);
        document.removeEventListener('mouseup', stopResize);
        
        // è°ƒæ•´å®Œæˆåï¼Œè§¦å‘iframeå†…éƒ¨å›¾è¡¨çš„resize
        const iframe = widget.querySelector('iframe');
        if (iframe && iframe.contentWindow) {
            try {
                setTimeout(function() {
                    iframe.contentWindow.dispatchEvent(new Event('resize'));
                }, 100);
            } catch (e) {
                console.log('æ— æ³•è§¦å‘iframeå†…éƒ¨resize');
            }
        }
    }
    
    document.addEventListener('mousemove', resize);
    document.addEventListener('mouseup', stopResize);
}

// åˆ‡æ¢å­—æ®µç»„
function toggleFieldGroup(groupName) {
    const list = document.getElementById(groupName + 'List');
    const icon = event.target.querySelector('.collapse-icon');
    
    if (list.style.display === 'none') {
        list.style.display = 'block';
        icon.textContent = 'â–¼';
    } else {
        list.style.display = 'none';
        icon.textContent = 'â–¶';
    }
}

// åŠ è½½æç¤º
function showLoading(message) {
    // åˆ›å»ºåŠ è½½æç¤ºå…ƒç´ 
    let loadingDiv = document.getElementById('loadingOverlay');
    if (!loadingDiv) {
        loadingDiv = document.createElement('div');
        loadingDiv.id = 'loadingOverlay';
        loadingDiv.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        `;
        
        const loadingContent = document.createElement('div');
        loadingContent.style.cssText = `
            background: white;
            padding: 30px 40px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            text-align: center;
        `;
        
        const spinner = document.createElement('div');
        spinner.style.cssText = `
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        `;
        
        const messageSpan = document.createElement('span');
        messageSpan.id = 'loadingMessage';
        messageSpan.style.cssText = 'font-size: 16px; color: #333;';
        messageSpan.textContent = message || 'åŠ è½½ä¸­...';
        
        loadingContent.appendChild(spinner);
        loadingContent.appendChild(messageSpan);
        loadingDiv.appendChild(loadingContent);
        document.body.appendChild(loadingDiv);
        
        // æ·»åŠ æ—‹è½¬åŠ¨ç”»
        const style = document.createElement('style');
        style.textContent = '@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }';
        document.head.appendChild(style);
    } else {
        const messageSpan = document.getElementById('loadingMessage');
        if (messageSpan) {
            messageSpan.textContent = message || 'åŠ è½½ä¸­...';
        }
        loadingDiv.style.display = 'flex';
    }
}

function hideLoading() {
    const loadingDiv = document.getElementById('loadingOverlay');
    if (loadingDiv) {
        loadingDiv.style.display = 'none';
    }
}

// ç”Ÿæˆå›¾è¡¨
function generateChart() {
    alert('å›¾è¡¨ç”ŸæˆåŠŸèƒ½å°†è¿æ¥åˆ°ç°æœ‰çš„å›¾è¡¨ç”ŸæˆAPI');
    closeChartConfig();
}

// é¡µé¢åŠ è½½å®Œæˆ
document.addEventListener('DOMContentLoaded', function() {
    // ä¸ºæ–‡ä»¶åˆ—è¡¨é¡¹æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
    initializeFileList();
    
    // å¦‚æœæœ‰æ–‡ä»¶ï¼Œè‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ª
    const fileList = document.getElementById('fileList');
    const firstFile = fileList.querySelector('.file-list-item');
    if (firstFile) {
        const fileId = firstFile.dataset.fileId;
        selectFile(fileId);
    }
});

// åˆå§‹åŒ–æ–‡ä»¶åˆ—è¡¨äº‹ä»¶
function initializeFileList() {
    const fileList = document.getElementById('fileList');
    const fileItems = fileList.querySelectorAll('.file-list-item');
    
    fileItems.forEach(item => {
        const fileId = item.dataset.fileId;
        
        // ç‚¹å‡»æ–‡ä»¶é¡¹é€‰æ‹©æ–‡ä»¶
        item.addEventListener('click', function(e) {
            // å¦‚æœç‚¹å‡»çš„æ˜¯åˆ é™¤æŒ‰é’®ï¼Œä¸è§¦å‘é€‰æ‹©
            if (e.target.classList.contains('file-delete-btn')) {
                return;
            }
            selectFile(fileId);
        });
        
        // åˆ é™¤æŒ‰é’®äº‹ä»¶
        const deleteBtn = item.querySelector('.file-delete-btn');
        if (deleteBtn) {
            deleteBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                deleteFile(fileId, e);
            });
        }
    });
}
</script>

<style>
/* æ–°ä»ªè¡¨ç›˜æ ·å¼ */
.dashboard-new-container {
    width: 100%;
    height: 100vh;
    display: flex;
    flex-direction: column;
    background: #f5f5f5;
}

/* é¡¶éƒ¨å¤´éƒ¨ */
.top-header {
    background: #2c5aa0;
    color: white;
    padding: 12px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.app-title {
    font-size: 20px;
    font-weight: 600;
    margin: 0;
}

.welcome-text {
    margin-right: 15px;
}

.btn-classic-mode {
    background: rgba(255,255,255,0.2);
    color: white;
    padding: 6px 16px;
    border-radius: 4px;
    text-decoration: none;
    transition: background 0.3s;
    margin-right: 15px;
    border: 1px solid rgba(255,255,255,0.3);
}

.btn-classic-mode:hover {
    background: rgba(255,255,255,0.35);
    border-color: rgba(255,255,255,0.5);
}

.btn-logout {
    background: rgba(255,255,255,0.2);
    color: white;
    padding: 6px 16px;
    border-radius: 4px;
    text-decoration: none;
    transition: background 0.3s;
}

.btn-logout:hover {
    background: rgba(255,255,255,0.3);
}

/* ä»ªè¡¨ç›˜æ¨¡å¼çš„è¯­è¨€åˆ‡æ¢æŒ‰é’®æ ·å¼ï¼ˆæ·±è‰²èƒŒæ™¯é€‚é…ï¼‰ */
.dashboard-new-container .btn-lang {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border-color: rgba(255, 255, 255, 0.3);
}

.dashboard-new-container .btn-lang:hover {
    background: rgba(255, 255, 255, 0.3);
    border-color: rgba(255, 255, 255, 0.5);
}

.dashboard-new-container .btn-lang.active {
    background: white;
    color: #2c5aa0;
    border-color: white;
}

/* ä¸»å¸ƒå±€ */
.main-layout {
    display: flex;
    flex: 1;
    overflow: hidden;
}

/* å·¦ä¾§è¾¹æ  */
.left-sidebar {
    width: 280px;
    background: white;
    border-right: 1px solid #ddd;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
}

.sidebar-panel {
    border-bottom: 1px solid #e0e0e0;
    padding: 15px;
}

.panel-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 15px;
    font-weight: 600;
    position: relative;
}

.panel-header .icon {
    font-size: 18px;
}

.close-config-btn {
    position: absolute;
    right: 0;
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #999;
    line-height: 1;
    padding: 0;
    width: 24px;
    height: 24px;
}

.close-config-btn:hover {
    color: #f56565;
}

.config-content {
    padding-top: 10px;
}

.config-textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
    font-family: inherit;
    resize: vertical;
}

.config-input {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

.panel-header h3 {
    margin: 0;
    font-size: 14px;
}

/* ä¸Šä¼ æŒ‰é’® */
.upload-section {
    margin-bottom: 15px;
}

.btn-upload {
    width: 100%;
    padding: 10px;
    background: #4CAF50;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: background 0.3s;
}

.btn-upload:hover {
    background: #45a049;
}

/* æ–‡ä»¶åˆ—è¡¨ */
.file-list-section {
    margin-top: 10px;
}

.file-list-header {
    font-size: 12px;
    color: #666;
    margin-bottom: 8px;
    font-weight: 600;
}

.file-list {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    background: #fff;
}

.file-list-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 12px;
    cursor: pointer;
    transition: all 0.2s;
    border-bottom: 1px solid #f0f0f0;
}

.file-list-item:last-child {
    border-bottom: none;
}

.file-list-item:hover {
    background: #f5f5f5;
}

.file-list-item.selected {
    background: #e3f2fd;
    border-left: 3px solid #2196F3;
}

.file-list-item .file-name {
    flex: 1;
    font-size: 13px;
    color: #333;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    margin-right: 8px;
}

.file-list-item.selected .file-name {
    color: #1976D2;
    font-weight: 600;
}

.file-delete-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 16px;
    padding: 4px 8px;
    border-radius: 4px;
    transition: all 0.2s;
    opacity: 0.6;
}

.file-delete-btn:hover {
    background: #ffebee;
    opacity: 1;
    transform: scale(1.1);
}

.file-list-empty {
    padding: 20px;
    text-align: center;
    color: #999;
    font-size: 13px;
}

/* å­—æ®µåˆ—è¡¨ */
.field-group {
    margin-bottom: 10px;
}

.field-group-header {
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 8px;
    background: #f5f5f5;
    border-radius: 4px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
}

.field-group-header:hover {
    background: #e8e8e8;
}

.collapse-icon {
    font-size: 10px;
}

.field-list {
    padding: 5px 0;
}

.field-item {
    padding: 8px 12px;
    margin: 2px 0;
    background: #f9f9f9;
    border: 1px solid #e0e0e0;
    border-radius: 3px;
    cursor: move;
    font-size: 13px;
    transition: all 0.2s;
}

.field-item:hover {
    background: #e3f2fd;
    border-color: #2196F3;
}

/* ä¸­é—´å†…å®¹åŒºåŸŸ */
.center-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

/* éƒ¨ä»¶å·¥å…·æ  */
.widget-toolbar {
    background: white;
    border-bottom: 1px solid #ddd;
    padding: 12px 20px;
    display: flex;
    align-items: center;
    gap: 15px;
}

.toolbar-label {
    font-weight: 600;
    font-size: 14px;
    color: #666;
}

.widget-items {
    display: flex;
    gap: 10px;
}

.widget-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 12px 16px;
    background: #f5f5f5;
    border: 2px dashed #ccc;
    border-radius: 6px;
    cursor: move;
    transition: all 0.3s;
    min-width: 70px;
}

.widget-item:hover {
    background: #e3f2fd;
    border-color: #2196F3;
    transform: translateY(-2px);
    box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);
}

.widget-icon {
    font-size: 24px;
    margin-bottom: 4px;
}

.widget-label {
    font-size: 12px;
    color: #666;
    font-weight: 500;
}

/* ä»ªè¡¨ç›˜ç”»å¸ƒ */
.dashboard-canvas {
    flex: 1;
    background: #fafafa;
    position: relative;
    overflow: auto;
    padding: 20px;
}

.canvas-placeholder {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    color: #999;
}

.placeholder-icon {
    font-size: 64px;
    margin-bottom: 15px;
}

.canvas-placeholder p {
    margin: 5px 0;
    font-size: 14px;
}

.placeholder-hint {
    font-size: 12px !important;
    color: #bbb;
}

.usage-tips {
    margin-top: 30px;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
    text-align: left;
    max-width: 400px;
    margin-left: auto;
    margin-right: auto;
}

.usage-tips p {
    margin: 8px 0;
    font-size: 13px;
    color: #666;
}

.usage-tips p:first-child {
    color: #333;
    margin-bottom: 12px;
}

/* ä»ªè¡¨ç›˜éƒ¨ä»¶ */
.dashboard-widget {
    position: absolute;
    min-width: 50px;  /* æœ€å°å®½åº¦ï¼Œé¿å…å®Œå…¨æ¶ˆå¤± */
    min-height: 50px;  /* æœ€å°é«˜åº¦ï¼Œé¿å…å®Œå…¨æ¶ˆå¤± */
    background: white;
    border: 2px solid #ddd;
    border-radius: 6px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
    cursor: pointer;
    transition: all 0.3s ease;
}

.dashboard-widget:hover {
    border-color: #2196F3;
    box-shadow: 0 4px 12px rgba(33, 150, 243, 0.2);
}

.dashboard-widget.widget-selected {
    border: 3px solid #2196F3;
    box-shadow: 0 4px 16px rgba(33, 150, 243, 0.4);
}

/* éšè—æ—§çš„å¤´éƒ¨ */
.widget-header {
    display: none;
}

/* æ‚¬åœå·¥å…·æ  */
.widget-toolbar-hover {
    position: absolute;
    top: 8px;
    right: 8px;
    display: none;
    gap: 5px;
    z-index: 10;
}

.dashboard-widget:hover .widget-toolbar-hover {
    display: flex;
}

.widget-tool-btn {
    background: rgba(255,255,255,0.95);
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 6px 10px;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.widget-tool-btn:hover {
    background: #f56565;
    color: white;
    border-color: #f56565;
}

/* éƒ¨ä»¶ç±»å‹æ ‡ç­¾ï¼ˆæ‚¬åœæ˜¾ç¤ºï¼‰ */
.widget-type-label {
    position: absolute;
    top: 8px;
    left: 8px;
    background: rgba(255,255,255,0.95);
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 4px 8px;
    font-size: 18px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    z-index: 5;
    display: none;
}

.dashboard-widget:hover .widget-type-label {
    display: block;
}

.widget-content {
    flex: 1;
    padding: 15px;
    overflow: auto;
}

.widget-placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: #999;
    font-size: 14px;
}

/* è°ƒæ•´å¤§å°æ‰‹æŸ„ */
.resizer {
    position: absolute;
    background: #2196F3;
    opacity: 0;
    transition: all 0.2s;
    z-index: 10;
}

.dashboard-widget:hover .resizer {
    opacity: 0.6;
}

.resizer:hover {
    opacity: 1 !important;
    background: #1976D2;
    transform: scale(1.2);
}

/* ä¸Šä¸‹å·¦å³è°ƒæ•´æ‰‹æŸ„ - æ›´å®½æ›´æ˜æ˜¾ */
.resizer-n { 
    top: -4px; 
    left: 5%; 
    right: 5%; 
    height: 8px; 
    cursor: ns-resize;
    border-radius: 4px;
}

.resizer-s { 
    bottom: -4px; 
    left: 5%; 
    right: 5%; 
    height: 8px; 
    cursor: ns-resize;
    border-radius: 4px;
}

.resizer-e { 
    right: -4px; 
    top: 5%; 
    bottom: 5%; 
    width: 8px; 
    cursor: ew-resize;
    border-radius: 4px;
}

.resizer-w { 
    left: -4px; 
    top: 5%; 
    bottom: 5%; 
    width: 8px; 
    cursor: ew-resize;
    border-radius: 4px;
}

/* å››è§’è°ƒæ•´æ‰‹æŸ„ - æ›´å¤§æ›´æ˜æ˜¾ */
.resizer-nw { 
    top: -5px; 
    left: -5px; 
    width: 14px; 
    height: 14px; 
    cursor: nwse-resize; 
    border-radius: 50%;
    border: 2px solid white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.resizer-ne { 
    top: -5px; 
    right: -5px; 
    width: 14px; 
    height: 14px; 
    cursor: nesw-resize; 
    border-radius: 50%;
    border: 2px solid white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.resizer-sw { 
    bottom: -5px; 
    left: -5px; 
    width: 14px; 
    height: 14px; 
    cursor: nesw-resize; 
    border-radius: 50%;
    border: 2px solid white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.resizer-se { 
    bottom: -5px; 
    right: -5px; 
    width: 14px; 
    height: 14px; 
    cursor: nwse-resize; 
    border-radius: 50%;
    border: 2px solid white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

/* é€‰ä¸­çŠ¶æ€ä¸‹å§‹ç»ˆæ˜¾ç¤ºè°ƒæ•´æ‰‹æŸ„ */
.widget-selected .resizer {
    opacity: 0.8;
}

.widget-selected .resizer:hover {
    opacity: 1;
}

/* æ¨¡æ€æ¡† */
.modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal-content {
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    max-width: 600px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
}

.modal-header {
    padding: 20px;
    border-bottom: 1px solid #ddd;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h2 {
    margin: 0;
    font-size: 18px;
}

.modal-close-btn {
    background: none;
    border: none;
    font-size: 28px;
    cursor: pointer;
    color: #999;
    line-height: 1;
}

.modal-close-btn:hover {
    color: #333;
}

.modal-body {
    padding: 20px;
}

.config-section {
    margin-bottom: 20px;
}

.config-label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    font-size: 14px;
    color: #333;
}

/* éƒ¨ä»¶æ‹–æ‹½åŒºåŸŸ */
.widget-drop-zone {
    min-height: 50px;
    padding: 10px;
    border: 2px dashed #cbd5e0;
    border-radius: 6px;
    background: #f7fafc;
    transition: all 0.3s;
}

.widget-drop-zone:hover {
    border-color: #4299e1;
    background: #ebf8ff;
}

.widget-drop-zone .drop-hint {
    color: #a0aec0;
    font-size: 13px;
    font-style: italic;
}

.field-tag {
    display: inline-flex;
    align-items: center;
    background: #e2e8f0;
    padding: 5px 10px;
    margin: 3px;
    border-radius: 4px;
    font-size: 12px;
}

/* é…ç½®é¢æ¿ä¸­çš„å­—æ®µåˆ—è¡¨ */
.config-fields-section {
    margin-bottom: 15px;
}

.config-field-group {
    margin-bottom: 10px;
}

.config-field-group-header {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 12px;
    background: #f7fafc;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.2s;
    border: 1px solid #e2e8f0;
}

.config-field-group-header:hover {
    background: #edf2f7;
}

.config-field-list {
    padding: 5px 0;
    max-height: 200px;
    overflow-y: auto;
}

.config-field-item {
    padding: 8px 12px;
    margin: 4px 0;
    background: #ffffff;
    border: 1px solid #e2e8f0;
    border-radius: 4px;
    cursor: move;
    font-size: 13px;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 5px;
}

.config-field-item:hover {
    background: #ebf8ff;
    border-color: #4299e1;
    box-shadow: 0 2px 4px rgba(66, 153, 225, 0.1);
}

.config-field-item:active {
    cursor: grabbing;
}

.config-select,
.text-input,
.file-input {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

.text-input {
    resize: vertical;
    font-family: inherit;
}

.config-buttons {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 20px;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s;
}

.btn-secondary {
    background: #f5f5f5;
    color: #333;
}

.btn-secondary:hover {
    background: #e0e0e0;
}

.btn-primary {
    background: #2196F3;
    color: white;
}

.btn-primary:hover {
    background: #1976D2;
}

/* å±æ€§æŒ‰é’® */
.btn-properties {
    padding: 6px 12px;
    background: #4CAF50;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.3s;
}

.btn-properties:hover {
    background: #45a049;
    transform: scale(1.05);
}

/* å±æ€§å¼¹çª— */
.properties-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
}

.properties-modal-content {
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    max-width: 600px;
    width: 90%;
    max-height: 80vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.properties-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid #e0e0e0;
    background: #f5f5f5;
}

.properties-modal-header h3 {
    margin: 0;
    font-size: 18px;
    color: #333;
}

.properties-modal-close {
    background: none;
    border: none;
    font-size: 28px;
    color: #666;
    cursor: pointer;
    line-height: 1;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    transition: all 0.2s;
}

.properties-modal-close:hover {
    background: #e0e0e0;
    color: #333;
}

.properties-modal-body {
    padding: 20px;
    overflow-y: auto;
}

.property-item {
    display: flex;
    padding: 12px 0;
    border-bottom: 1px solid #f0f0f0;
}

.property-item:last-child {
    border-bottom: none;
}

.property-label {
    font-weight: 600;
    color: #666;
    min-width: 100px;
    flex-shrink: 0;
}

.property-value {
    color: #333;
    flex: 1;
    word-break: break-word;
}

.properties-modal-footer {
    padding: 15px 20px;
    border-top: 1px solid #e0e0e0;
    display: flex;
    justify-content: flex-end;
    background: #f5f5f5;
}

/* å¯Œæ–‡æœ¬ç¼–è¾‘å™¨æ ·å¼ */
.rich-text-toolbar {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    padding: 10px;
    background: #f7fafc;
    border: 1px solid #e2e8f0;
    border-radius: 4px;
    margin-bottom: 10px;
}

.toolbar-group {
    display: flex;
    gap: 4px;
    align-items: center;
    padding: 2px;
    border-right: 1px solid #cbd5e0;
}

.toolbar-group:last-child {
    border-right: none;
}

.toolbar-btn {
    min-width: 32px;
    height: 32px;
    padding: 4px 8px;
    background: white;
    border: 1px solid #cbd5e0;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.toolbar-btn:hover {
    background: #edf2f7;
    border-color: #4299e1;
    transform: translateY(-1px);
}

.toolbar-btn:active {
    transform: translateY(0);
}

.toolbar-select {
    height: 32px;
    padding: 4px 8px;
    border: 1px solid #cbd5e0;
    border-radius: 4px;
    background: white;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.2s;
}

.toolbar-select:hover {
    border-color: #4299e1;
}

.toolbar-select:focus {
    outline: none;
    border-color: #4299e1;
    box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
}

.toolbar-color-label {
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 4px 8px;
    background: white;
    border: 1px solid #cbd5e0;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
}

.toolbar-color-label:hover {
    border-color: #4299e1;
}

.toolbar-color-label span {
    font-size: 14px;
    font-weight: 600;
}

.rich-text-editor {
    font-family: 'Microsoft YaHei', Arial, sans-serif;
    outline: none;
    cursor: text;
}

.rich-text-editor:empty:before {
    content: attr(placeholder);
    color: #a0aec0;
}

.rich-text-editor:focus {
    border-color: #4299e1;
    box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
}

/* ç¼–è¾‘å™¨å†…å®¹æ ·å¼ */
.rich-text-editor p {
    margin: 0 0 1em 0;
}

.rich-text-editor p:last-child {
    margin-bottom: 0;
}

.rich-text-editor strong {
    font-weight: 700;
}

.rich-text-editor em {
    font-style: italic;
}

.rich-text-editor u {
    text-decoration: underline;
}
</style>
{% endblock %}

